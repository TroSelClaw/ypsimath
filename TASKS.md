# YpsiMath â€” Task Breakdown

> Generated by task-architect from PRD v1.2 (2026-02-18)
> Total tasks: 113 | Phases: 0â€“6

---

## Summary

| Phase | Name | Tasks | Est. Effort | Priority |
|-------|------|-------|-------------|----------|
| 0 | Foundation | 18 | 4â€“6 weeks | P0 |
| 1 | Content Pipeline + Wiki | 26 | 6â€“8 weeks | P0 |
| 2 | Chat-tutor + Student Profile | 16 | 4â€“6 weeks | P0 |
| 3 | Exams and Assessment | 14 | 4â€“6 weeks | P1 |
| 4 | Teacher Dashboard + Reports | 13 | 3â€“4 weeks | P1 |
| 5 | Flashcards + Video | 11 | 3â€“4 weeks | P2 |
| 6 | Polish + Launch | 15 | 2â€“3 weeks | P1 |

## Critical Path

```
TASK-001 (Next.js scaffold)
  â†’ TASK-003 (Supabase project)
    â†’ TASK-004 (DB schema: users)
      â†’ TASK-005 (DB schema: content)
        â†’ TASK-006 (DB schema: activity/progress)
          â†’ TASK-007 (Auth flow)
            â†’ TASK-009 (Role-based routing)
              â†’ TASK-014 (KaTeX pipeline)
                â†’ TASK-019 (Source RAG DB)
                  â†’ TASK-020 (Content generation script)
                    â†’ TASK-021 (Embedding pipeline)
                      â†’ TASK-022 (Quality review dashboard)
                        â†’ TASK-027 (Wiki page renderer)
                          â†’ TASK-036 (Hybrid RAG engine)
                            â†’ TASK-037 (Chat API route)
                              â†’ TASK-038 (Chat UI)
                                â†’ TASK-049 (Student profile system)
                                  â†’ TASK-055 (Exam generation)
                                    â†’ TASK-060 (PDF export)
                                      â†’ TASK-062 (AI grading)
```

---

## Phase 0 â€” Foundation

**Goal**: Working Next.js app with Supabase, auth, DB schema, design system, and CI/CD. Every subsequent phase builds on this.

---

### TASK-001: Initialize Next.js 15 project with TypeScript and tooling

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: None
- **Estimated effort**: S
- **Description**: Bootstrap the Next.js 15 App Router project with TypeScript strict mode, ESLint, Prettier, and path aliases. Configure `tsconfig.json` with `@/*` alias. Set up `.env.local.example` with all required environment variable keys documented.
- **Acceptance criteria**:
  - [ ] `next dev` starts without errors on port 3000
  - [ ] TypeScript strict mode enabled, `tsc --noEmit` passes
  - [ ] ESLint + Prettier configured and passing on empty scaffold
  - [ ] `@/*` path alias resolves correctly
  - [ ] `.env.local.example` lists all required env vars with comments
- **Files to create/modify**:
  - `package.json`, `tsconfig.json`, `next.config.ts`, `.eslintrc.json`, `.prettierrc`, `.env.local.example`
- **Technical notes**: Use `create-next-app@latest` with `--typescript --app --tailwind --eslint`. Node 22+. Use `pnpm` as package manager.

---

### TASK-002: Install and configure Tailwind CSS + shadcn/ui design system

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-001
- **Estimated effort**: M
- **Description**: Configure Tailwind CSS v4 with custom design tokens (color palette, typography scale, spacing). Initialize shadcn/ui with the `new-york` style. Define CSS custom properties for dark mode, light mode, and UU-mode (high-contrast accessibility mode). Add `next-themes` for theme switching.
- **Acceptance criteria**:
  - [ ] `tailwind.config.ts` defines custom color tokens (primary, surface, muted, border, etc.)
  - [ ] shadcn/ui initialized; `components/ui/` directory populated with Button, Card, Input, Dialog, Badge starters
  - [ ] Three theme CSS classes: `.theme-dark`, `.theme-light`, `.theme-uu` with distinct custom properties
  - [ ] `ThemeProvider` wraps root layout; theme persists in localStorage
  - [ ] UU-mode visually distinct: larger base font (18px+), high contrast, simplified shadows
  - [ ] No flash of unstyled content on page load
- **Files to create/modify**:
  - `tailwind.config.ts`, `app/globals.css`, `components/ui/`, `components/theme-provider.tsx`, `lib/constants/themes.ts`
- **Technical notes**: Use CSS variables for all color tokens so shadcn/ui components automatically respond to theme. UU-mode overrides should be additive on top of light mode.

---

### TASK-003: Set up Supabase project in EU Frankfurt region

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-001
- **Estimated effort**: S
- **Description**: Create Supabase project in `eu-central-1` (Frankfurt). Configure Supabase client for both server (SSR) and client contexts using `@supabase/ssr`. Set up environment variables. Enable pgvector extension. Configure Supabase Storage buckets for user uploads and generated PDFs.
- **Acceptance criteria**:
  - [ ] Supabase project created in Frankfurt (EU) region
  - [ ] `createClient` (server) and `createBrowserClient` (client) helpers implemented in `lib/supabase/`
  - [ ] pgvector extension enabled: `CREATE EXTENSION IF NOT EXISTS vector`
  - [ ] Storage buckets created: `user-uploads` (private, 10MB limit), `exam-pdfs` (private), `videos` (public)
  - [ ] Connection verified: health check query returns successfully
  - [ ] All Supabase env vars documented in `.env.local.example`
- **Files to create/modify**:
  - `lib/supabase/server.ts`, `lib/supabase/client.ts`, `lib/supabase/middleware.ts`
- **Technical notes**: Use `@supabase/ssr` (not deprecated `auth-helpers`). Server client must be created per-request (no singleton). Storage bucket CORS configured for app origin only.

---

### TASK-004: Database schema migrations â€” user and class tables

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-003
- **Estimated effort**: M
- **Description**: Write Supabase SQL migrations for all user-related tables: `profiles`, `student_profiles`, `classes`, `class_memberships`. Include triggers to auto-create a `profiles` row when a new `auth.users` entry is created. Apply RLS policies scoped by user ID and role.
- **Acceptance criteria**:
  - [ ] Migration file(s) in `supabase/migrations/` with correct timestamp prefix
  - [ ] Tables created: `profiles`, `student_profiles`, `classes`, `class_memberships`
  - [ ] Trigger `on_auth_user_created` inserts into `profiles` on new signup
  - [ ] RLS enabled on all four tables
  - [ ] RLS policies: users read/update own profile; teachers read profiles in their classes; admins read all
  - [ ] `role` ENUM type created: `student`, `teacher`, `admin`
  - [ ] Migration applied successfully via `supabase db push`
- **Files to create/modify**:
  - `supabase/migrations/0001_user_tables.sql`
- **Technical notes**: `profiles.id` must reference `auth.users(id)` with `ON DELETE CASCADE`. The trigger must run as `SECURITY DEFINER` to bypass RLS on insert. Include `school_org_id` and `auth_provider` fields for future Feide integration.

---

### TASK-005: Database schema migrations â€” content tables

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-004
- **Estimated effort**: M
- **Description**: Write migrations for content-related tables: `subjects`, `content_elements`, `content_versions`, `videos`. Create necessary ENUM types. Set up HNSW index on `content_elements.embedding` and GIN index on `content_elements.fts`. Seed `subjects` table with R1 as initial subject.
- **Acceptance criteria**:
  - [ ] Tables created: `subjects`, `content_elements`, `content_versions`, `videos`
  - [ ] ENUM types: `content_type` (theory, rule, example, exercise, exploration, flashcard), `exercise_format`, `content_status` (draft, flagged, reviewed, published)
  - [ ] HNSW index on `embedding VECTOR(1536)` with cosine operator
  - [ ] GIN index on `fts TSVECTOR`
  - [ ] Trigger updates `fts` column from `content` on insert/update using `to_tsvector('norwegian', ...)`
  - [ ] R1 subject seeded in `subjects` table
  - [ ] RLS: published content readable by all authenticated users; draft/flagged/reviewed readable only by admin/teacher
- **Files to create/modify**:
  - `supabase/migrations/0002_content_tables.sql`
- **Technical notes**: `embedding VECTOR(1536)` matches `text-embedding-3-small` output dimensions. Use `hnsw` index type (faster than ivfflat for this scale). Norwegian FTS config: `'norwegian'`.

---

### TASK-006: Database schema migrations â€” activity, progress, exam, chat, and semester plan tables

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-005
- **Estimated effort**: M
- **Description**: Write migrations for remaining tables: `activity_log`, `exercise_attempts`, `flashcard_progress`, `conversations`, `messages`, `exams`, `exam_questions`, `exam_submissions`, `exam_answers`, `teacher_notes`, `semester_plans`, `semester_plan_entries`, `semester_plan_versions`. Apply RLS policies for each.
- **Acceptance criteria**:
  - [ ] All 13 tables created with correct columns and foreign key constraints
  - [ ] ENUM types created: `activity_type`, `check_method`, `self_report_result`, `exam_status`, `submission_status`, `message_role`, `entry_type`, `assessment_type`
  - [ ] RLS enabled on all tables; students access only their own rows; teachers access rows for their class members; admins access all
  - [ ] `exam_submissions.scan_pdf_url` column references Supabase Storage path
  - [ ] Migration applies cleanly after migrations 0001 and 0002
- **Files to create/modify**:
  - `supabase/migrations/0003_activity_exam_chat_semester_tables.sql`
- **Technical notes**: `exercise_attempts.image_url` and `messages.image_url` store Supabase Storage paths, not public URLs. Generate signed URLs server-side on demand.

---

### TASK-007: Supabase Auth â€” email+password registration and login

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-004
- **Estimated effort**: M
- **Description**: Implement registration (`/registrer`) and login (`/logg-inn`) pages using Supabase Auth email+password flow. Use Server Actions for form submission. Validate input with Zod. Handle and display errors in Norwegian. No email verification in MVP.
- **Acceptance criteria**:
  - [ ] `/registrer` page: email, password, confirm-password fields with Zod validation
  - [ ] `/logg-inn` page: email, password fields; submits via Server Action
  - [ ] Successful registration creates `auth.users` entry and triggers `profiles` insert
  - [ ] Successful login redirects to `/` (or last-visited page)
  - [ ] Error messages displayed in Norwegian (e.g., "Ugyldig e-post eller passord")
  - [ ] Loading state on submit button prevents double-submit
  - [ ] `@supabase/ssr` cookie session management wired up in `middleware.ts`
- **Files to create/modify**:
  - `app/(auth)/registrer/page.tsx`, `app/(auth)/logg-inn/page.tsx`, `app/actions/auth.ts`, `middleware.ts`
- **Technical notes**: Use Next.js Server Actions (not API routes) for auth mutations. The middleware must refresh the session on every request via `supabase.auth.getUser()`.

---

### TASK-008: Supabase Auth â€” session middleware and logout

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-007
- **Estimated effort**: S
- **Description**: Configure `middleware.ts` to protect routes, refresh sessions, and redirect unauthenticated users to `/logg-inn`. Implement logout Server Action that calls `supabase.auth.signOut()` and clears cookies. Add a logout button in the navigation.
- **Acceptance criteria**:
  - [ ] Middleware runs on all routes except `/(auth)` and public assets
  - [ ] Unauthenticated requests to protected routes redirect to `/logg-inn?next=<path>`
  - [ ] Session refresh happens on every request (no stale tokens)
  - [ ] Logout clears session and redirects to `/logg-inn`
  - [ ] `next` query param used to redirect user back after login
- **Files to create/modify**:
  - `middleware.ts`, `app/actions/auth.ts` (add signOut), `components/layout/nav-user.tsx`

---

### TASK-009: Role-based routing and layout shells

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-008
- **Estimated effort**: M
- **Description**: Implement role-based routing using Next.js route groups. Create layout shells for each role: student layout (sidebar with wiki nav + planet journey), teacher layout (sidebar with class + dashboard links), admin layout (extends teacher with content management links). Read user role from `profiles` table and enforce access in middleware or layout.
- **Acceptance criteria**:
  - [ ] Route groups: `(student)`, `(teacher)`, `(admin)` with separate layout files
  - [ ] Middleware or layout checks `profiles.role` and redirects mismatched roles to their home
  - [ ] Student sidebar: Wiki, Chat, My progress, Flashcards links
  - [ ] Teacher sidebar: Class overview, Exams, Semester plan, Student reports links
  - [ ] Admin sidebar: Extends teacher + Content review, Content generation links
  - [ ] Active link highlighted in sidebar
  - [ ] Sidebar collapses to icon-only on narrow viewports
- **Files to create/modify**:
  - `app/(student)/layout.tsx`, `app/(teacher)/layout.tsx`, `app/(admin)/layout.tsx`, `components/layout/sidebar-student.tsx`, `components/layout/sidebar-teacher.tsx`, `components/layout/sidebar-admin.tsx`

---

### TASK-010: Class and student administration UI

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-009
- **Estimated effort**: M
- **Description**: Build teacher/admin UI for creating classes and managing student enrollment. Teacher can create a class (name, subject, school year), then add students by email (creates accounts if they don't exist) or by generating invite links. Display class roster with student names and roles.
- **Acceptance criteria**:
  - [ ] Teacher can create a class via `/klasse/ny` form (name, subject, school year)
  - [ ] Teacher can add existing students to class by email lookup
  - [ ] Teacher can generate a class invite link that auto-enrolls new registrants
  - [ ] Class roster page lists all enrolled students with their display name and email
  - [ ] Admin can view all classes across all teachers
  - [ ] Server Actions handle all mutations with Zod validation
  - [ ] RLS ensures teachers only manage their own classes
- **Files to create/modify**:
  - `app/(teacher)/klasse/ny/page.tsx`, `app/(teacher)/klasse/[id]/page.tsx`, `app/actions/classes.ts`

---

### TASK-011: Design system â€” typography and KaTeX font setup

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-002
- **Estimated effort**: S
- **Description**: Configure the typography scale using a serif body font (e.g., Source Serif 4) and a sans-serif UI font (e.g., Inter). Ensure KaTeX fonts are loaded correctly (via `katex/dist/katex.min.css`). Establish the Norwegian text rendering baseline: correct quote marks, hyphenation, and number formatting.
- **Acceptance criteria**:
  - [ ] Body font loaded via `next/font/google` (no layout shift)
  - [ ] KaTeX CSS imported globally; KaTeX renders correctly for sample inline and display math
  - [ ] Norwegian locale applied for number formatting utilities (`lib/format.ts`)
  - [ ] Font sizes, line heights, and weights documented in `tailwind.config.ts`
  - [ ] Dark/light/UU themes all have readable contrast ratios (WCAG AA minimum)
- **Files to create/modify**:
  - `app/layout.tsx`, `app/globals.css`, `tailwind.config.ts`, `lib/format.ts`

---

### TASK-012: KaTeX rendering component and Markdown pipeline

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-011
- **Estimated effort**: M
- **Description**: Build a reusable `<MathContent>` React component that renders Markdown with embedded LaTeX using `remark` + `rehype-katex` + `remark-math`. Handle both inline `$...$` and display `$$...$$` math. Ensure the pipeline is SSR-compatible (renders on server for SEO and performance). Write unit tests for edge cases.
- **Acceptance criteria**:
  - [ ] `<MathContent content={markdown} />` renders Markdown + KaTeX correctly
  - [ ] Inline math `$x^2$` and display math `$$\int_0^1 x\,dx$$` both render
  - [ ] Server-side rendering works (no hydration errors)
  - [ ] Code blocks styled with syntax highlighting (shiki or equivalent)
  - [ ] Vitest unit tests cover: plain text, inline math, display math, code block, mixed content
  - [ ] Component handles malformed LaTeX gracefully (shows error boundary, not crash)
- **Files to create/modify**:
  - `components/content/math-content.tsx`, `components/content/math-content.test.tsx`, `lib/markdown/pipeline.ts`
- **Technical notes**: Use `remark-math` + `rehype-katex` for the pipeline. Server render with `unified().process()` for RSC compatibility. `rehype-katex` options: `throwOnError: false`, `output: 'html'`.

---

### TASK-013: CI/CD â€” GitHub Actions + Vercel auto-deploy pipeline

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-001
- **Estimated effort**: S
- **Description**: Set up GitHub Actions workflow that runs on every push to `main` and on PRs: type check, lint, and unit tests. Configure Vercel project for auto-deploy from GitHub. Set up preview deployments for PRs. Store all secrets in GitHub Actions secrets and Vercel environment variables.
- **Acceptance criteria**:
  - [ ] `.github/workflows/ci.yml` runs `tsc --noEmit`, `eslint`, and `vitest run` on push/PR
  - [ ] CI passes on green scaffold
  - [ ] Vercel project linked to GitHub repo; pushes to `main` deploy to production
  - [ ] PR branches get Vercel preview URL
  - [ ] Environment variables set in Vercel for production (Supabase URL, anon key, service role key, AI API keys)
  - [ ] CI failure blocks merge (branch protection rule documented in README)
- **Files to create/modify**:
  - `.github/workflows/ci.yml`, `vercel.json` (if needed)

---

### TASK-014: Responsive application shell and navigation

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-009, TASK-011
- **Estimated effort**: M
- **Description**: Build the full responsive application shell: top navigation bar (logo, theme toggle, user menu), role-specific sidebar, and main content area. Implement the three-theme switcher (dark/light/UU). Make the layout work correctly on MacBook Air (1280px+), tablet (768px+), and mobile (375px+). All text and labels in Norwegian.
- **Acceptance criteria**:
  - [ ] Top nav: logo, theme toggle (three states: dark/light/UU), user avatar + dropdown (profile, logout)
  - [ ] Sidebar collapses to hamburger on mobile; slides in as drawer
  - [ ] Main content area has correct padding and max-width (1100px readable line length)
  - [ ] Theme switcher persists preference in localStorage and applies instantly (no flash)
  - [ ] UU-mode: base font 18px, high contrast colors, reduced motion if `prefers-reduced-motion`
  - [ ] Keyboard navigation: Tab through nav items, Escape closes mobile drawer
  - [ ] Norwegian labels throughout: "Hjem", "Wiki", "Chat", "Fremgang" etc.
- **Files to create/modify**:
  - `components/layout/app-shell.tsx`, `components/layout/top-nav.tsx`, `components/layout/theme-switcher.tsx`, `app/(student)/layout.tsx` (update)

---

### TASK-015: Rate limiting middleware

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-008
- **Estimated effort**: S
- **Description**: Implement per-user, per-endpoint rate limiting using an in-memory sliding window (Upstash Redis optional for MVP scale). Apply limits to auth endpoints, chat API, image upload endpoints, and exam grading endpoints. Return HTTP 429 with a Norwegian error message and `Retry-After` header.
- **Acceptance criteria**:
  - [ ] Auth endpoints limited to 10 requests/minute per IP
  - [ ] Chat API limited to 30 messages/hour per user
  - [ ] Image upload limited to 20 uploads/hour per user
  - [ ] Exam grading limited to 5 requests/hour per user
  - [ ] HTTP 429 returned with `{ error: "For mange forespÃ¸rsler. PrÃ¸v igjen om X sekunder." }`
  - [ ] `Retry-After` header set correctly
  - [ ] Rate limiter is a reusable utility function applied in route handlers
- **Files to create/modify**:
  - `lib/rate-limit.ts`, applied in relevant `app/api/*/route.ts` files
- **Technical notes**: Use sliding window with `Map<string, number[]>` for MVP (50 users). Document upgrade path to Upstash Redis for scale.

---

### TASK-016: Error handling and logging infrastructure

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-001
- **Estimated effort**: S
- **Description**: Set up structured error handling: global error boundary (`error.tsx`), not-found page (`not-found.tsx`), and a `lib/errors.ts` module with typed error classes. Integrate Sentry (or equivalent) for production error tracking. All user-facing error messages in Norwegian.
- **Acceptance criteria**:
  - [ ] `app/error.tsx` catches unhandled errors and shows user-friendly Norwegian message
  - [ ] `app/not-found.tsx` shows Norwegian 404 page with navigation back to home
  - [ ] `lib/errors.ts` defines `AppError`, `AuthError`, `ValidationError`, `NotFoundError` classes
  - [ ] Server-side errors logged with context (user ID, route, timestamp) â€” no PII in logs
  - [ ] Sentry (or Vercel Analytics) configured for production error tracking
  - [ ] Empty `catch` blocks are forbidden (ESLint rule `no-empty`)
- **Files to create/modify**:
  - `app/error.tsx`, `app/not-found.tsx`, `lib/errors.ts`, `lib/logger.ts`

---

### TASK-017: Zod validation schemas for all data models

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-006
- **Estimated effort**: M
- **Description**: Create a central `lib/schemas/` directory with Zod schemas matching every DB table and API payload. These schemas are used for Server Action input validation, API route body validation, and type inference throughout the app. Schemas must reflect the DB ENUM types exactly.
- **Acceptance criteria**:
  - [ ] Zod schemas defined for: `Profile`, `StudentProfile`, `Class`, `ContentElement`, `Exercise`, `Conversation`, `Message`, `Exam`, `ExamQuestion`, `SemesterPlan`
  - [ ] ENUM schemas match DB ENUM values exactly
  - [ ] Schemas exported from `lib/schemas/index.ts`
  - [ ] TypeScript types inferred from Zod schemas used throughout the codebase (not duplicate manual types)
  - [ ] At least one Vitest test per schema verifying valid and invalid inputs
- **Files to create/modify**:
  - `lib/schemas/users.ts`, `lib/schemas/content.ts`, `lib/schemas/exams.ts`, `lib/schemas/chat.ts`, `lib/schemas/semester.ts`, `lib/schemas/index.ts`

---

### TASK-018: Phase 0 integration smoke test

- **Phase**: 0
- **Priority**: P0
- **Dependencies**: TASK-001 through TASK-017
- **Estimated effort**: S
- **Description**: Write a Playwright end-to-end smoke test covering the critical Phase 0 flows: registration, login, role-based redirect, theme switching, and logout. This test runs in CI and acts as the regression baseline for all subsequent phases.
- **Acceptance criteria**:
  - [ ] Playwright installed and configured in `playwright.config.ts`
  - [ ] E2E test: register new student account â†’ redirected to student home
  - [ ] E2E test: login as teacher â†’ redirected to teacher dashboard
  - [ ] E2E test: unauthenticated access to `/` â†’ redirect to `/logg-inn`
  - [ ] E2E test: theme switch cycles through dark â†’ light â†’ UU
  - [ ] E2E test: logout â†’ session cleared, redirect to `/logg-inn`
  - [ ] Tests pass in CI pipeline
- **Files to create/modify**:
  - `e2e/auth.spec.ts`, `playwright.config.ts`

---

## Phase 1 â€” Content Pipeline + Wiki

**Goal**: Generate R1 content via LLM, review it via admin dashboard, and display it as an interactive wiki with exercises, visualizations, and the semester plan.

---

### TASK-019: Source RAG database setup (internal content pipeline)

- **Phase**: 1
- **Priority**: P0
- **Dependencies**: TASK-005
- **Estimated effort**: M
- **Description**: Set up a separate internal Supabase schema (or separate table prefix `src_`) for the source RAG database used during content generation. This database holds chunked reference material (existing textbook HTML, past exam PDFs) that is NEVER served to students. Write the ingestion script that reads source files, chunks them, embeds them, and stores them in the source RAG table.
- **Acceptance criteria**:
  - [ ] `src_chunks` table created with columns: `id`, `source_file`, `chunk_index`, `content`, `content_type`, `subject_id`, `competency_goals TEXT[]`, `embedding VECTOR(1536)`
  - [ ] Ingestion script `scripts/ingest-source-rag.ts` reads HTML/PDF files from `data/raw/`
  - [ ] Chunks generated at 500-token size with 100-token overlap
  - [ ] Embeddings generated via `text-embedding-3-small` through Vercel AI Gateway
  - [ ] HNSW index created on `src_chunks.embedding`
  - [ ] RLS: source chunks readable only by service role (never by student/teacher JWT)
  - [ ] Script is idempotent (re-running does not create duplicates)
- **Files to create/modify**:
  - `supabase/migrations/0004_source_rag_table.sql`, `scripts/ingest-source-rag.ts`, `lib/ingestion/chunker.ts`, `lib/ingestion/embedder.ts`
- **Technical notes**: This is a one-time admin operation, not a user-facing feature. Script runs with service role key, not anon key.

---

### TASK-020: Content generation script (Claude Opus 4.6 via Vercel AI Gateway)

- **Phase**: 1
- **Priority**: P0
- **Dependencies**: TASK-019
- **Estimated effort**: L
- **Description**: Build the content generation script `scripts/generate-content.ts` that takes a competency goal code (e.g., `R1-04`) and generates all content element types: theory, rules, examples, exercises (all formats), explorations, and flashcards. Script uses hybrid RAG on source database for context, then calls Claude Opus 4.6 via Vercel AI Gateway (ZDR). Output is inserted into `content_elements` with status `draft`.
- **Acceptance criteria**:
  - [ ] Script accepts `--subject r1 --goal R1-04 --type all` CLI arguments
  - [ ] Retrieves top-10 source RAG chunks for the given competency goal (hybrid search)
  - [ ] Generates all content types for the given goal in one or more LLM calls
  - [ ] Generated content inserted into `content_elements` with `status = 'draft'`
  - [ ] LaTeX uses KaTeX-compatible syntax validated with a regex/parse check
  - [ ] Norwegian notation enforced in system prompt: comma decimal separator, Norwegian terms
  - [ ] `content_metadata` JSONB populated: difficulty, prerequisites, hints, answer (for exercises)
  - [ ] Dry-run mode (`--dry-run`) prints output without inserting
  - [ ] Script logs progress and any LLM errors to console
- **Files to create/modify**:
  - `scripts/generate-content.ts`, `lib/generation/content-generator.ts`, `lib/generation/prompts.ts`
- **Technical notes**: Use Vercel AI SDK `generateText` with Claude Opus 4.6. System prompt must specify Norwegian notation conventions, KaTeX syntax, and content element JSON schema. Include all 12 R1 competency goals as references in the prompt.

---

### TASK-021: Embedding pipeline for production content

- **Phase**: 1
- **Priority**: P0
- **Dependencies**: TASK-020
- **Estimated effort**: M
- **Description**: Build a script `scripts/embed-content.ts` that generates embeddings for all `content_elements` where `embedding IS NULL` and status is `reviewed` or `published`. Also build a Supabase Edge Function or cron job that auto-embeds newly published content. Update the `fts` tsvector column simultaneously.
- **Acceptance criteria**:
  - [ ] Script processes all un-embedded content in batches of 50
  - [ ] Embeddings generated via `text-embedding-3-small` (1536d) through Vercel AI Gateway
  - [ ] `content_elements.embedding` and `fts` columns updated atomically
  - [ ] Script is idempotent (skips already-embedded content)
  - [ ] Error handling: failed embeddings logged and retried up to 3 times
  - [ ] Supabase DB webhook or Edge Function triggers embedding on status change to `published`
- **Files to create/modify**:
  - `scripts/embed-content.ts`, `supabase/functions/embed-on-publish/index.ts`

---

### TASK-022: LLM quality-flagging pass for generated content

- **Phase**: 1
- **Priority**: P0
- **Dependencies**: TASK-020
- **Estimated effort**: M
- **Description**: Build a script `scripts/flag-content.ts` that runs a separate LLM pass (Claude Sonnet 4.6 via Vercel AI Gateway) over all `draft` content elements to check for mathematical errors, unclear formulations, and missing steps. Flagged items have their status set to `flagged` with a `flag_reason` stored in `content_metadata`. Unflagged draft items move to `reviewed`.
- **Acceptance criteria**:
  - [ ] Script processes all `draft` content elements for a given subject
  - [ ] LLM evaluates each element with a structured checklist: mathematical correctness, pedagogical clarity, LaTeX validity, Norwegian notation
  - [ ] Elements with issues: `status = 'flagged'`, `content_metadata.flag_reason` populated
  - [ ] Elements without issues: `status = 'reviewed'`
  - [ ] Confidence score stored in `content_metadata.flag_confidence`
  - [ ] Script produces a summary report (N flagged, N passed)
- **Files to create/modify**:
  - `scripts/flag-content.ts`, `lib/generation/quality-checker.ts`

---

### TASK-023: Admin content review dashboard

- **Phase**: 1
- **Priority**: P0
- **Dependencies**: TASK-022, TASK-009
- **Estimated effort**: L
- **Description**: Build the admin content review dashboard at `/admin/innhold`. Shows a filterable list of content elements by status (draft/flagged/reviewed/published), subject, and content type. Flagged items appear first. Clicking an item opens a side-by-side view: generated content (left) vs. source RAG context (right). Admin can approve (â†’ `reviewed`), edit inline, or reject (â†’ `draft`) each item. Includes a "Publish all reviewed" bulk action.
- **Acceptance criteria**:
  - [ ] `/admin/innhold` lists content elements with status badges and filter controls
  - [ ] Flagged items sorted to top with flag reason displayed
  - [ ] Side-by-side view shows generated content with KaTeX-rendered math on left; source RAG chunks on right
  - [ ] Inline editing: admin edits `content` field in a textarea with live KaTeX preview
  - [ ] Approve button: sets status to `reviewed`, records `reviewed_by` and `reviewed_at`
  - [ ] Publish button: sets status to `published`, triggers embedding (TASK-021)
  - [ ] Edit saves a `content_versions` row before overwriting
  - [ ] Bulk "Publish all reviewed" action with confirmation dialog
  - [ ] Pagination: 50 items per page
- **Files to create/modify**:
  - `app/(admin)/innhold/page.tsx`, `app/(admin)/innhold/[id]/page.tsx`, `components/admin/content-review-card.tsx`, `components/admin/content-editor.tsx`, `app/actions/content.ts`

---

### TASK-024: Wiki page renderer â€” theory, rules, and examples

- **Phase**: 1
- **Priority**: P0
- **Dependencies**: TASK-012, TASK-021
- **Estimated effort**: L
- **Description**: Build the core wiki page renderer at `/wiki/[subject]/[topic]`. A topic page fetches all published `content_elements` for that topic (ordered by `sort_order`) and renders them in sequence. Theory and rule elements render with `<MathContent>`. Example elements render as collapsible step-by-step solutions with progressive disclosure (collapsed by default, expandable).
- **Acceptance criteria**:
  - [ ] Route `/wiki/r1/[topic]` renders all published content elements for that topic
  - [ ] `theory` and `rule` elements render with `<MathContent>` and appropriate heading hierarchy
  - [ ] `example` elements: title visible by default, steps collapsed â€” "Vis lÃ¸sning" button expands
  - [ ] `rule` elements styled distinctly (border, background tint) to stand out visually
  - [ ] Correct `sort_order` maintained in rendering
  - [ ] Page is Server Component (SSR); math renders server-side
  - [ ] Breadcrumb navigation: Fag â†’ Kapittel â†’ Tema
  - [ ] "Neste tema" and "Forrige tema" navigation links at bottom
  - [ ] Page loads in < 2 seconds (LCP)
- **Files to create/modify**:
  - `app/(student)/wiki/[subject]/[topic]/page.tsx`, `components/wiki/theory-block.tsx`, `components/wiki/rule-block.tsx`, `components/wiki/example-block.tsx`

---

### TASK-025: Wiki exercises â€” self-report, auto-check, and hint system

- **Phase**: 1
- **Priority**: P0
- **Dependencies**: TASK-024
- **Estimated effort**: L
- **Description**: Build the exercise rendering and interaction system. Four exercise formats: freeform (self-report only), multiple choice (auto-check), numeric input (auto-check with tolerance), and interactive/drag-drop. All formats support: "Vis hint" (progressive, tracked), "Vis fasit" (reveals solution, required before self-report), and self-report buttons (Fikk til / Delvis / Fikk ikke til). Record `exercise_attempts` rows. Optional image upload for work-checking (TASK-034).
- **Acceptance criteria**:
  - [ ] `<ExerciseBlock>` component handles all four `exercise_format` types
  - [ ] "Vis hint" button shows hints one-at-a-time from `content_metadata.hints[]`; `hints_used` incremented
  - [ ] "Vis fasit" reveals collapsible solution; sets `viewed_solution = true`
  - [ ] Self-report buttons (Fikk til / Delvis / Fikk ikke til) only appear after fasit is revealed
  - [ ] Multiple choice: clicking an option auto-checks against `content_metadata.answer`; result shown immediately
  - [ ] Numeric input: input field + submit; checked against `content_metadata.answer` with `content_metadata.tolerance`
  - [ ] Each interaction creates/updates an `exercise_attempts` row (Server Action)
  - [ ] `activity_log` row created for each exercise attempt
  - [ ] Vitest unit tests for auto-check logic (tolerance math, multiple choice matching)
- **Files to create/modify**:
  - `components/wiki/exercise-block.tsx`, `components/wiki/hint-system.tsx`, `components/wiki/self-report.tsx`, `app/actions/exercises.ts`, `lib/exercises/auto-check.ts`

---

### TASK-026: Pyodide Python runtime integration

- **Phase**: 1
- **Priority**: P1
- **Dependencies**: TASK-024
- **Estimated effort**: M
- **Description**: Integrate Pyodide (CPython in WebAssembly) for Python code blocks in the wiki. Content elements with `content_type = 'exploration'` may include runnable Python code. Build a `<PythonRunner>` component that lazy-loads Pyodide on first use, shows a code editor (CodeMirror or similar), and runs code in-browser. Output (print statements, matplotlib plots) displayed below the editor.
- **Acceptance criteria**:
  - [ ] `<PythonRunner code={initialCode} />` component renders in wiki pages
  - [ ] Pyodide loaded lazily (not on initial page load) with loading spinner
  - [ ] User can edit the code in an editable textarea or CodeMirror editor
  - [ ] "KjÃ¸r kode" button executes code in Pyodide sandbox
  - [ ] stdout captured and displayed below editor
  - [ ] Errors displayed with line number reference (in Norwegian if possible)
  - [ ] matplotlib plots rendered as images via `matplotlib.pyplot.savefig` + base64
  - [ ] Pyodide sandbox is isolated (no fetch, no file system access beyond Pyodide's virtual FS)
  - [ ] Component works in light, dark, and UU themes
- **Files to create/modify**:
  - `components/wiki/python-runner.tsx`, `lib/pyodide/loader.ts`
- **Technical notes**: Pyodide is ~10MB; lazy-load via dynamic import. Consider a Web Worker to prevent blocking the main thread during execution.

---

### TASK-027: Mafs interactive visualization components

- **Phase**: 1
- **Priority**: P1
- **Dependencies**: TASK-024
- **Estimated effort**: L
- **Description**: Build a library of reusable Mafs-based interactive visualization components for R1 topics. Required for MVP: function plotter with movable tangent line (derivative visualization), area-under-curve shading (integration intro), vector addition in 2D, and a general-purpose parametric plot. Components are rendered in wiki `exploration` elements.
- **Acceptance criteria**:
  - [ ] `<FunctionPlot>`: plots f(x), adjustable domain/range, grid, axes labels
  - [ ] `<TangentExplorer>`: plots f(x) with a draggable point; tangent line updates in real-time; derivative value displayed
  - [ ] `<AreaUnderCurve>`: plots f(x) with shaded area between two adjustable bounds; area value computed numerically
  - [ ] `<VectorPlot>`: renders 2D vectors with addition visualization
  - [ ] All components accept LaTeX label strings (rendered with KaTeX)
  - [ ] Keyboard-navigable draggable points (arrow keys move point by step)
  - [ ] Dark/light/UU themes respected (background, axes, grid colors from CSS variables)
  - [ ] Components lazy-loaded (Mafs is 160kB â€” always loaded per PRD, but component split is fine)
- **Files to create/modify**:
  - `components/visualizations/function-plot.tsx`, `components/visualizations/tangent-explorer.tsx`, `components/visualizations/area-under-curve.tsx`, `components/visualizations/vector-plot.tsx`, `components/visualizations/index.ts`

---

### TASK-028: GeoGebra embed component

- **Phase**: 1
- **Priority**: P2
- **Dependencies**: TASK-024
- **Estimated effort**: S
- **Description**: Build a `<GeoGebraEmbed>` component that renders a GeoGebra applet inside a sandboxed iframe. Content elements with `content_metadata.geogebra_id` or `content_metadata.geogebra_url` use this component. Lazy-load the iframe only when it scrolls into view.
- **Acceptance criteria**:
  - [ ] `<GeoGebraEmbed materialId="..." />` renders the applet in a sandboxed iframe
  - [ ] Iframe only loaded when component enters viewport (Intersection Observer)
  - [ ] Loading skeleton shown while iframe initializes
  - [ ] Responsive: 16:9 aspect ratio maintained
  - [ ] "Ã…pne i GeoGebra" external link provided as fallback
- **Files to create/modify**:
  - `components/wiki/geogebra-embed.tsx`

---

### TASK-029: Planet journey â€” linear gamification map

- **Phase**: 1
- **Priority**: P1
- **Dependencies**: TASK-024, TASK-033
- **Estimated effort**: L
- **Description**: Build the planet journey visualization at `/fremgang` (student home). Topics from the semester plan are displayed as "planets" along a linear path. Completed topics have a distinct visual state (filled, colored). Current topic is highlighted. Future topics are visible but dimmed. Clicking a planet navigates to that wiki topic. Uses CSS/SVG for the path â€” no heavy 3D library needed for MVP.
- **Acceptance criteria**:
  - [ ] `/fremgang` page shows all R1 topics as planets in semester-plan order
  - [ ] Completed topics (all exercises attempted or marked complete): green/filled planet icon
  - [ ] Current topic: highlighted with pulse animation (respects `prefers-reduced-motion`)
  - [ ] Future topics: dimmed but clickable (student can read ahead)
  - [ ] SVG path connects planets in sequence; scrollable horizontally or vertically
  - [ ] Clicking a planet navigates to `/wiki/r1/[topic]`
  - [ ] Progress percentage displayed (N of M topics completed)
  - [ ] Planet map adapts to mobile (vertical scroll layout)
- **Files to create/modify**:
  - `app/(student)/fremgang/page.tsx`, `components/journey/planet-map.tsx`, `components/journey/planet-node.tsx`
- **Technical notes**: Keep it professional and clean â€” no cartoon graphics. Use geometric shapes (circles, connecting lines) with good typography. GSAP for subtle animations.

---

### TASK-030: Semester plan â€” teacher setup wizard

- **Phase**: 1
- **Priority**: P1
- **Dependencies**: TASK-010, TASK-006
- **Estimated effort**: L
- **Description**: Build the semester plan setup wizard for teachers at `/laerer/semesterplan/ny`. Multi-step form: (1) date range, (2) weekly schedule (days + times), (3) holidays and school events, (4) assessment placement, (5) topic order with drag-and-drop. On submit, generate the plan by distributing topics across available sessions.
- **Acceptance criteria**:
  - [ ] 5-step wizard with progress indicator; each step validates before proceeding
  - [ ] Step 1: start date, end date pickers with calendar UI
  - [ ] Step 2: checkbox for each weekday, time picker for each selected day, session duration in minutes
  - [ ] Step 3: Norwegian public holidays auto-populated (2026-2027 school year); teacher can add custom holidays
  - [ ] Step 4: teacher adds assessment entries (type + week); drag to reorder
  - [ ] Step 5: drag-and-drop topic reordering (React DnD Kit or similar)
  - [ ] "Generer plan" button: calls server action that distributes topics, creates `semester_plans` + `semester_plan_entries` rows
  - [ ] Success: redirects to calendar view (TASK-031)
  - [ ] All form state persisted in `sessionStorage` so wizard survives page refresh
- **Files to create/modify**:
  - `app/(teacher)/semesterplan/ny/page.tsx`, `components/semester/wizard-steps/`, `app/actions/semester-plan.ts`, `lib/semester/generator.ts`
- **Technical notes**: The plan generator (`lib/semester/generator.ts`) is a pure function: `generatePlan(config) â†’ SemesterPlanEntry[]`. Write unit tests for this function. Norwegian public holidays hardcoded for 2026-2027; document where to update for future years.

---

### TASK-031: Semester plan â€” calendar view and drag-and-drop editing

- **Phase**: 1
- **Priority**: P1
- **Dependencies**: TASK-030
- **Estimated effort**: L
- **Description**: Build the semester plan calendar view at `/laerer/semesterplan/[id]`. Shows a month-by-month calendar with each teaching session's assigned topic. Teacher can drag topics to different dates, add/remove sessions, and the plan rebalances automatically. Chat-based editing: a text input allows natural language commands like "Flytt vektorer til etter jul".
- **Acceptance criteria**:
  - [ ] Calendar renders all `semester_plan_entries` in month grid layout
  - [ ] Topic entries drag-and-droppable between date cells
  - [ ] Assessment entries shown with distinct color/icon
  - [ ] Holiday entries shown as blocked-out days
  - [ ] Dragging triggers server action to update `semester_plan_entries` order/dates
  - [ ] Chat input accepts natural language plan edits; sends to LLM action; plan updated
  - [ ] "Lagre versjon" button creates a `semester_plan_versions` snapshot
  - [ ] Table view toggle: switch between calendar and list table view
  - [ ] Changes auto-save (debounced 2 seconds)
- **Files to create/modify**:
  - `app/(teacher)/semesterplan/[id]/page.tsx`, `components/semester/calendar-view.tsx`, `components/semester/plan-table.tsx`, `components/semester/plan-chat-editor.tsx`, `app/actions/semester-plan.ts` (update)

---

### TASK-032: Semester plan â€” student timeline view

- **Phase**: 1
- **Priority**: P1
- **Dependencies**: TASK-030, TASK-029
- **Estimated effort**: M
- **Description**: Expose the semester plan to students as a timeline integrated with the planet journey. Each planet node shows its scheduled date. A "Du er i rute / foran / bak" progress indicator compares current completed topics against the planned schedule. The next upcoming topic is prominently displayed.
- **Acceptance criteria**:
  - [ ] Student home (`/fremgang`) shows next topic date ("Neste tema: Derivasjonsregler â€” 3. mars")
  - [ ] Planet nodes display their scheduled date in a tooltip or label
  - [ ] Progress status banner: "Du er i rute", "Du er X temaer foran plan", or "Du er X temaer bak plan"
  - [ ] Status computed by comparing `student_profiles.mastered_competency_goals` against `semester_plan_entries` up to today
  - [ ] Student cannot modify the semester plan (read-only)
- **Files to create/modify**:
  - `app/(student)/fremgang/page.tsx` (update), `lib/semester/progress.ts`

---

### TASK-033: Student progress tracking â€” activity logging

- **Phase**: 1
- **Priority**: P0
- **Dependencies**: TASK-025
- **Estimated effort**: M
- **Description**: Implement the activity logging system that records student interactions. Log entries for: wiki page views, exercise attempts, video watches, flashcard sessions, and chat messages. Build the server action `logActivity()` that inserts into `activity_log` and updates `student_profiles` aggregates (total exercises, total time, mastered/struggling competency goals).
- **Acceptance criteria**:
  - [ ] `logActivity(userId, type, metadata)` Server Action inserts into `activity_log`
  - [ ] Wiki page view logged on page load (with `duration_seconds` updated on unmount via beacon API)
  - [ ] Exercise attempt logs: check method, result, time, competency goals
  - [ ] `student_profiles.total_exercises_completed` incremented on each completed attempt
  - [ ] `student_profiles.mastered_competency_goals` updated when student scores correct on auto-check or self-reports "Fikk til" on 3+ consecutive attempts for a goal
  - [ ] `student_profiles.struggling_competency_goals` updated for goals with repeated incorrect attempts
  - [ ] All logging is fire-and-forget (non-blocking to UI)
  - [ ] RLS ensures students can only write to their own `activity_log` rows
- **Files to create/modify**:
  - `app/actions/activity.ts`, `lib/progress/tracker.ts`

---

### TASK-034: Image upload for exercise work-checking

- **Phase**: 1
- **Priority**: P1
- **Dependencies**: TASK-025, TASK-003
- **Estimated effort**: M
- **Description**: Add the optional "Sjekk utregningen min" (image upload) flow to exercise blocks. After viewing the solution, students can photograph their handwritten work and upload it for AI feedback. The image is uploaded to Supabase Storage (`user-uploads/[userId]/`), then analyzed by Gemini 3 Flash via Vercel AI Gateway. Feedback displayed inline and saved to `exercise_attempts.image_feedback`.
- **Acceptance criteria**:
  - [ ] "ðŸ“· Sjekk utregningen min" button appears after solution is revealed
  - [ ] Camera capture (mobile) and file picker (desktop) both work
  - [ ] Image validated: max 10MB, JPEG/PNG/WEBP only
  - [ ] Image uploaded to Supabase Storage at `user-uploads/[userId]/[attemptId].jpg`
  - [ ] `POST /api/exercise/image-check` sends image to Gemini 3 Flash with exercise context
  - [ ] Feedback returned and displayed in Norwegian: what was correct, what was wrong, suggested correction
  - [ ] Feedback saved to `exercise_attempts.image_feedback`
  - [ ] Upload progress indicator shown during upload
  - [ ] Rate limit: 20 image checks per hour per user (TASK-015)
- **Files to create/modify**:
  - `components/wiki/image-upload.tsx`, `app/api/exercise/image-check/route.ts`, `lib/ai/image-analyzer.ts`

---

### TASK-035: Wiki search functionality

- **Phase**: 1
- **Priority**: P2
- **Dependencies**: TASK-021
- **Estimated effort**: M
- **Description**: Build a content search feature accessible from the top navigation. Uses FTS (`fts` tsvector) for fast keyword search on published content. Results grouped by content type and topic. Clicking a result navigates to the wiki page with the relevant element highlighted.
- **Acceptance criteria**:
  - [ ] Search input in top nav with keyboard shortcut (Cmd/Ctrl + K)
  - [ ] Results appear within 500ms using FTS on `content_elements.fts` (Norwegian dictionary)
  - [ ] Results filtered to `status = 'published'` only
  - [ ] Results grouped: Teori, Regler, Eksempler, Oppgaver
  - [ ] Max 20 results shown; "Se alle" link for full results page
  - [ ] Clicking result navigates to `/wiki/r1/[topic]#[element-id]`
  - [ ] Search input is accessible (ARIA role, keyboard navigation of results)
- **Files to create/modify**:
  - `components/search/search-dialog.tsx`, `app/api/search/route.ts`

---

### TASK-036: Phase 1 integration test â€” wiki and content pipeline

- **Phase**: 1
- **Priority**: P0
- **Dependencies**: TASK-019 through TASK-035
- **Estimated effort**: S
- **Description**: Write Playwright E2E tests covering the Phase 1 wiki and content pipeline flows. Tests verify the full content lifecycle (generation â†’ review â†’ publish â†’ display) and student exercise interaction flows.
- **Acceptance criteria**:
  - [ ] E2E: admin logs in â†’ navigates to content review â†’ approves an element â†’ element appears as published
  - [ ] E2E: student logs in â†’ opens wiki topic â†’ sees theory, rules, and examples rendered
  - [ ] E2E: student opens exercise â†’ clicks hint â†’ clicks "Vis fasit" â†’ self-reports "Fikk til"
  - [ ] E2E: student views planet map â†’ current topic highlighted â†’ clicking planet navigates to wiki
  - [ ] All tests pass in CI
- **Files to create/modify**:
  - `e2e/wiki.spec.ts`, `e2e/content-admin.spec.ts`

---

## Phase 2 â€” Chat-tutor + Student Profile

**Goal**: Working AI tutor with hybrid RAG, streaming responses, image analysis, and a student profile system.

---

### TASK-037: Hybrid RAG engine for production content

- **Phase**: 2
- **Priority**: P0
- **Dependencies**: TASK-021
- **Estimated effort**: L
- **Description**: Implement the hybrid search RAG engine for the production content database. Combines vector search (HNSW cosine) and FTS (tsvector Norwegian) using Reciprocal Rank Fusion (k=60). Expose as a reusable `hybridSearch(query, options)` function. Options include: subject filter, content type filter, competency goal filter, and student profile weighting.
- **Acceptance criteria**:
  - [ ] `hybridSearch(query, { subjectIds, contentTypes, limit, studentProfile })` returns ranked `ContentElement[]`
  - [ ] Vector search: query embedded with `text-embedding-3-small`, top-K from HNSW index
  - [ ] FTS search: `plainto_tsquery('norwegian', query)` on `fts` column
  - [ ] RRF merges both result sets with k=60: `score = 1/(k + rank_vector) + 1/(k + rank_fts)`
  - [ ] Cross-subject search: if no subject filter, searches all published content
  - [ ] Student profile weighting: results from `student.current_subject` boosted
  - [ ] Results include metadata: subject, topic, content_type, competency_goals
  - [ ] Vitest unit tests for RRF merge function with mock data
  - [ ] Query time < 500ms for 10,000 content elements
- **Files to create/modify**:
  - `lib/rag/hybrid-search.ts`, `lib/rag/rrf.ts`, `lib/rag/embedder.ts`, `supabase/functions/hybrid-search/index.ts` (optional Edge Function)
- **Technical notes**: Implement as a Supabase RPC function (`hybrid_search`) for performance; call from server-side code only.

---

### TASK-038: Chat API route with streaming and RAG context

- **Phase**: 2
- **Priority**: P0
- **Dependencies**: TASK-037, TASK-006
- **Estimated effort**: L
- **Description**: Build the `POST /api/chat` route handler using Vercel AI SDK `streamText`. The handler: validates input, loads conversation history from `messages` table, retrieves student profile, runs hybrid RAG search, assembles the system prompt with student context + RAG results, streams the LLM response (Gemini 3 Flash via Vercel AI Gateway). Saves assistant message to `messages` table after completion.
- **Acceptance criteria**:
  - [ ] `POST /api/chat` accepts `{ conversationId, content, imageUrl? }` body
  - [ ] Authentication required; returns 401 if unauthenticated
  - [ ] Last 10 messages loaded from `messages` for conversation history
  - [ ] Student profile loaded and injected into system prompt
  - [ ] RAG search runs on user query; top-5 results included as context
  - [ ] System prompt: pedagogical tutor persona, Norwegian only, guides rather than gives answers
  - [ ] Response streams token-by-token using Vercel AI SDK `StreamingTextResponse`
  - [ ] After stream completes, assistant message saved to `messages` with `sources` JSONB (RAG chunks used)
  - [ ] Rate limit: 30 messages/hour per user (TASK-015)
  - [ ] ZDR verified: no logging in Vercel AI Gateway settings
- **Files to create/modify**:
  - `app/api/chat/route.ts`, `lib/ai/chat-handler.ts`, `lib/ai/system-prompt.ts`

---

### TASK-039: Chat UI with streaming and KaTeX rendering

- **Phase**: 2
- **Priority**: P0
- **Dependencies**: TASK-038, TASK-012
- **Estimated effort**: L
- **Description**: Build the chat interface at `/chat` and `/chat/[conversationId]`. Uses Vercel AI SDK `useChat` hook for streaming. Messages from the assistant render with `<MathContent>` (KaTeX + Markdown). Source citations shown as expandable chips below assistant messages. Conversation list in sidebar for history.
- **Acceptance criteria**:
  - [ ] `/chat` creates a new conversation; `/chat/[id]` loads existing
  - [ ] Message input: textarea with Enter to send (Shift+Enter for newline), send button
  - [ ] User messages displayed in bubble (right-aligned); assistant messages (left-aligned with avatar)
  - [ ] Assistant messages render Markdown + KaTeX via `<MathContent>`
  - [ ] Streaming: assistant message appears token by token; typing indicator during TTFT
  - [ ] Source chips: each RAG source shown as clickable chip â†’ navigates to wiki page
  - [ ] Conversation list in sidebar shows last message preview and timestamp
  - [ ] "Ny samtale" button creates a new conversation
  - [ ] Error state: if API fails, show Norwegian error message with retry button
  - [ ] Empty state: starter prompts when no conversation exists ("SpÃ¸r om derivasjon...", etc.)
- **Files to create/modify**:
  - `app/(student)/chat/page.tsx`, `app/(student)/chat/[id]/page.tsx`, `components/chat/message-list.tsx`, `components/chat/message-input.tsx`, `components/chat/source-chips.tsx`, `components/chat/conversation-sidebar.tsx`

---

### TASK-040: Chat image upload â€” take photo of problem or work

- **Phase**: 2
- **Priority**: P1
- **Dependencies**: TASK-039
- **Estimated effort**: M
- **Description**: Add image attachment to the chat input. Students can photograph a problem from their textbook or handwritten work. Image uploaded to Supabase Storage, URL included in the chat API call. Gemini 3 Flash handles vision analysis; the analyzed content is included in the LLM context for the response.
- **Acceptance criteria**:
  - [ ] Camera icon in chat input opens file picker / camera (mobile)
  - [ ] Image preview shown in message composer before sending
  - [ ] Image uploaded to `user-uploads/[userId]/chat/[messageId].jpg` before API call
  - [ ] `imageUrl` included in `POST /api/chat` body
  - [ ] API route: if `imageUrl` present, calls Gemini 3 Flash for image description, includes description in LLM context
  - [ ] Uploaded image displayed as thumbnail in user's message bubble
  - [ ] Max 10MB; JPEG/PNG/WEBP only; client-side validation
  - [ ] Rate limit: 20 image uploads/hour (TASK-015)
- **Files to create/modify**:
  - `components/chat/image-attach.tsx`, `app/api/chat/route.ts` (update)

---

### TASK-041: Student profile view and goals setting

- **Phase**: 2
- **Priority**: P1
- **Dependencies**: TASK-033
- **Estimated effort**: M
- **Description**: Build the student profile page at `/profil`. Shows: competency goal mastery grid (red/yellow/green per goal), statistics (exercises completed, time spent, streak), and a goals section where students can set their target grade and specific topics to focus on. Goals saved to `student_profiles.goals` JSONB.
- **Acceptance criteria**:
  - [ ] `/profil` shows student display name, current subject, enrollment date
  - [ ] Competency goal grid: R1-01 through R1-12 with color status (green = mastered, yellow = in progress, red = not started)
  - [ ] Statistics: total exercises completed, total time (hours), current week's activity
  - [ ] Goals form: target grade (1-6 scale), free-text improvement areas; saved via Server Action
  - [ ] `student_profiles.goals` JSONB updated on save
  - [ ] Profile page is read-only for teachers (they see it from dashboard â€” TASK-065)
- **Files to create/modify**:
  - `app/(student)/profil/page.tsx`, `components/profile/competency-grid.tsx`, `components/profile/stats-cards.tsx`, `app/actions/profile.ts`

---

### TASK-042: AI-generated study recommendations

- **Phase**: 2
- **Priority**: P2
- **Dependencies**: TASK-041, TASK-037
- **Estimated effort**: M
- **Description**: On the student profile page, display AI-generated personalized study recommendations. A server-side LLM call (Claude Sonnet 4.6) analyzes the student's profile (struggling goals, recent activity, target grade) and returns 2-3 specific suggestions ("Ã˜v mer pÃ¥ kjerneregelen â€” du har feil pÃ¥ 4 av 5 oppgaver" etc.). Cached for 24 hours.
- **Acceptance criteria**:
  - [ ] Recommendations section on `/profil` shows 2-3 bullet-point suggestions
  - [ ] Recommendations generated by LLM with student profile context (no raw personal data in prompt â€” only aggregated: "4/5 incorrect on goal R1-04")
  - [ ] Recommendations cached in a server-side cache (24h TTL) keyed by student ID + profile hash
  - [ ] "Oppdater anbefalinger" button forces refresh (rate-limited to once/hour)
  - [ ] Loading skeleton while generating
  - [ ] Recommendations reference specific wiki topics with clickable links
- **Files to create/modify**:
  - `components/profile/recommendations.tsx`, `app/api/profile/recommendations/route.ts`, `lib/ai/recommendations.ts`

---

### TASK-043: Cross-subject differentiation in chat

- **Phase**: 2
- **Priority**: P2
- **Dependencies**: TASK-038
- **Estimated effort**: M
- **Description**: Enhance the chat RAG and system prompt to support cross-subject differentiation. Strong R1 students can receive R2-level context when appropriate. Struggling R1 students receive supplementary 1T-level context. The system prompt and RAG filters are adjusted based on the student profile. The chat never reveals to the student which subject level it's referencing.
- **Acceptance criteria**:
  - [ ] System prompt includes student profile summary: current subject, mastered goals, struggling goals, target grade
  - [ ] RAG search queries all published subjects (not just R1) when cross-subject is beneficial
  - [ ] For students with `mastered_competency_goals` count > 8/12: R2 content boosted in RAG results
  - [ ] For students with `struggling_competency_goals` count > 4: 1T/1P content included (without labeling it as such in response)
  - [ ] LLM instructed in system prompt: never say "dette er fra R2" or similar â€” just use the content naturally
  - [ ] Vitest test: verify cross-subject RAG filter logic
- **Files to create/modify**:
  - `lib/ai/system-prompt.ts` (update), `lib/rag/hybrid-search.ts` (update)

---

### TASK-044: Conversation history and management

- **Phase**: 2
- **Priority**: P1
- **Dependencies**: TASK-039
- **Estimated effort**: S
- **Description**: Build conversation management: list all conversations, rename a conversation, delete a conversation. Conversations are soft-deleted (GDPR: actual deletion on account deletion). The conversation list in the sidebar is searchable.
- **Acceptance criteria**:
  - [ ] Conversation sidebar: sorted by `updated_at` descending; shows title + relative timestamp
  - [ ] Long-press or hover on conversation: "Gi nytt navn" and "Slett" options
  - [ ] Rename: inline edit of `conversations.title`
  - [ ] Delete: confirmation dialog; sets a `deleted_at` soft-delete column (add migration)
  - [ ] Deleted conversations not shown in list (filtered by `deleted_at IS NULL`)
  - [ ] Sidebar search: filter conversations by title keyword (client-side)
- **Files to create/modify**:
  - `components/chat/conversation-sidebar.tsx` (update), `app/actions/conversations.ts`, migration to add `deleted_at`

---

### TASK-045: Phase 2 integration test â€” chat and student profile

- **Phase**: 2
- **Priority**: P0
- **Dependencies**: TASK-037 through TASK-044
- **Estimated effort**: S
- **Description**: Playwright E2E tests for the chat tutor and student profile system.
- **Acceptance criteria**:
  - [ ] E2E: student sends a math question â†’ receives streaming response with KaTeX â†’ source chips shown
  - [ ] E2E: student attaches image to chat â†’ message sent â†’ response references image content
  - [ ] E2E: student views profile â†’ competency grid shows correct colors based on exercise history
  - [ ] E2E: student renames and deletes a conversation
  - [ ] All tests pass in CI
- **Files to create/modify**:
  - `e2e/chat.spec.ts`, `e2e/profile.spec.ts`

---

## Phase 3 â€” Exams and Assessment

**Goal**: Full exam workflow â€” teacher generates exams, exports PDF, uploads scanned answers, and AI grades them.

---

### TASK-046: Exam generation â€” teacher parameter form

- **Phase**: 3
- **Priority**: P1
- **Dependencies**: TASK-005, TASK-009
- **Estimated effort**: M
- **Description**: Build the exam creation form at `/laerer/prover/ny`. Teacher selects: total duration, Part 1 vs Part 2 duration split, competency goals to cover, difficulty distribution, and whether to include freeform or multiple-choice questions. On submit, calls the exam generation API.
- **Acceptance criteria**:
  - [ ] Form fields: title, total duration (minutes), Part 1 duration, competency goals (multi-select checkboxes from R1-01 to R1-12), difficulty mix (sliders: easy/medium/hard %)
  - [ ] Number of questions estimated and displayed based on duration (reference: 5-hour exam = ~15 questions)
  - [ ] Zod validation on all fields
  - [ ] Submit triggers `POST /api/exams/generate` with loading state
  - [ ] On success: redirect to exam preview page (TASK-047)
  - [ ] Error: Norwegian error message with retry option
- **Files to create/modify**:
  - `app/(teacher)/prover/ny/page.tsx`, `components/exams/exam-config-form.tsx`

---

### TASK-047: Exam generation â€” AI generation API

- **Phase**: 3
- **Priority**: P1
- **Dependencies**: TASK-046, TASK-037
- **Estimated effort**: L
- **Description**: Build `POST /api/exams/generate`. Uses RAG on `content_elements` (exercises and rules) filtered by the selected competency goals and difficulty. Sends to GPT-5 via Vercel AI Gateway with the exam parameters and retrieved context. LLM generates exam questions in structured JSON. Questions saved to `exams` and `exam_questions` tables. Returns exam ID.
- **Acceptance criteria**:
  - [ ] API retrieves relevant exercises from RAG filtered by competency goals
  - [ ] Prompt includes: Norwegian exam format conventions, Part 1 (no tools) vs Part 2 (with tools) distinction, requested difficulty mix
  - [ ] LLM returns structured JSON: `{ questions: [{ part, question_number, content, max_points, solution, grading_criteria }] }`
  - [ ] JSON validated with Zod before DB insert
  - [ ] `exams` row created with `status = 'draft'`; `exam_questions` rows inserted
  - [ ] Questions do not duplicate exercises already in the student-facing wiki (cross-reference check)
  - [ ] Total max points calculated and stored
  - [ ] Timeout: 60 seconds max; returns 504 with retry instruction if exceeded
- **Files to create/modify**:
  - `app/api/exams/generate/route.ts`, `lib/ai/exam-generator.ts`

---

### TASK-048: Exam preview and editing

- **Phase**: 3
- **Priority**: P1
- **Dependencies**: TASK-047
- **Estimated effort**: M
- **Description**: Build the exam preview page at `/laerer/prover/[id]`. Shows generated exam questions in order. Teacher can edit question text (inline, with KaTeX preview), adjust points, reorder questions via drag-and-drop, delete questions, or manually add a question. "Regenerer oppgave" replaces a single question via LLM. Exam status can be moved from `draft` to `ready`.
- **Acceptance criteria**:
  - [ ] Exam preview renders questions with KaTeX-rendered math
  - [ ] Part 1 and Part 2 clearly separated with headers
  - [ ] Inline edit: click question content â†’ textarea with live KaTeX preview
  - [ ] Points field: editable number input per question
  - [ ] Drag-and-drop reorder questions (within Part 1 or Part 2 only)
  - [ ] "Regenerer oppgave" button calls LLM to replace one question
  - [ ] "Legg til oppgave" button opens a form to manually type a question
  - [ ] "Marker som klar" button: sets `status = 'ready'`
  - [ ] All edits auto-saved (debounced)
- **Files to create/modify**:
  - `app/(teacher)/prover/[id]/page.tsx`, `components/exams/exam-preview.tsx`, `components/exams/question-editor.tsx`

---

### TASK-049: PDF export â€” exam and solution PDF via Puppeteer

- **Phase**: 3
- **Priority**: P1
- **Dependencies**: TASK-048
- **Estimated effort**: L
- **Description**: Build a Puppeteer-based PDF export service. When a teacher clicks "Eksporter PDF", a Next.js API route renders an HTML exam template (styled with Tailwind, KaTeX for math), runs Puppeteer headless Chrome to convert to PDF, and returns the PDF file or uploads it to Supabase Storage. Generate two PDFs: the student exam and the teacher's solution + grading criteria PDF.
- **Acceptance criteria**:
  - [ ] `GET /api/exams/[id]/pdf?type=exam` returns student-facing PDF
  - [ ] `GET /api/exams/[id]/pdf?type=solution` returns teacher-facing solution PDF (auth: teacher/admin only)
  - [ ] HTML template: YpsiMath header, school name, date, subject, time limits, Part 1 and Part 2 sections
  - [ ] KaTeX renders correctly in PDF (Puppeteer loads KaTeX CSS from CDN or inline)
  - [ ] PDF page breaks inserted between questions at natural points
  - [ ] PDF uploaded to Supabase Storage: `exam-pdfs/[examId]/exam.pdf` and `exam-pdfs/[examId]/solution.pdf`
  - [ ] `exams.exam_pdf_url` and `exams.solution_pdf_url` updated in DB
  - [ ] Download link shown on exam preview page
  - [ ] PDF generation timeout: 30 seconds
- **Files to create/modify**:
  - `app/api/exams/[id]/pdf/route.ts`, `lib/pdf/exam-renderer.ts`, `app/exam-print/[id]/page.tsx` (print template)
- **Technical notes**: Puppeteer adds ~300MB to the serverless function. Use `@sparticuz/chromium` for Vercel compatibility. Consider generating PDF as a background job for large exams.

---

### TASK-050: Exam submission upload â€” scanned PDF intake

- **Phase**: 3
- **Priority**: P1
- **Dependencies**: TASK-049, TASK-006
- **Estimated effort**: M
- **Description**: Build the scanned exam upload interface at `/laerer/prover/[id]/rett`. Teacher uploads a single PDF containing all students' scanned answers (sorted by student). UI guides the teacher to assign PDF page ranges to individual students. Creates `exam_submissions` rows for each student and stores the scanned PDF in Supabase Storage.
- **Acceptance criteria**:
  - [ ] File upload zone: PDF only, max 200MB (50 students Ã— 4MB each)
  - [ ] After upload, PDF is stored in `user-uploads/exams/[examId]/scan.pdf`
  - [ ] Teacher UI: list class students; assign page range for each student (start page, end page)
  - [ ] "Start retting" button: creates `exam_submissions` rows for each student with `status = 'scanned'`; triggers grading job
  - [ ] Progress: shows which students have page ranges assigned (N/total)
  - [ ] Validation: page ranges must not overlap; all pages must be assigned before proceeding
- **Files to create/modify**:
  - `app/(teacher)/prover/[id]/rett/page.tsx`, `components/exams/scan-uploader.tsx`, `components/exams/student-page-mapper.tsx`, `app/actions/exam-submissions.ts`

---

### TASK-051: AI exam grading with error analysis

- **Phase**: 3
- **Priority**: P1
- **Dependencies**: TASK-050, TASK-038
- **Estimated effort**: L
- **Description**: Build the AI grading pipeline. For each student submission: extract their page range from the scanned PDF, send pages as images to Gemini 3 Flash for OCR and handwriting analysis, then send the OCR'd text + grading criteria to GPT-5 for scoring. Store results in `exam_answers`. Run submissions in parallel (max 10 concurrent).
- **Acceptance criteria**:
  - [ ] Grading triggered per student submission (`status = 'grading'`)
  - [ ] PDF page extraction: split by student page ranges using `pdf-lib` or similar
  - [ ] Image-to-text: Gemini 3 Flash OCRs each page; output saved as `student_answer_text`
  - [ ] Scoring: GPT-5 receives question, grading criteria, max points, and OCR text; returns `score_percent`, `error_analysis` JSONB, `confidence_score`, `llm_feedback`
  - [ ] `exam_answers` rows created for each question
  - [ ] `exam_submissions.total_score_percent` aggregated from per-question scores
  - [ ] `exam_submissions.status` set to `'graded'` on completion
  - [ ] Error analysis categorizes errors: `fortegnsfeil`, `konseptfeil`, `regnefeil`, `manglende_steg`
  - [ ] Grading runs in background; teacher sees live progress via Supabase Realtime
  - [ ] Low-confidence answers (< 70%) flagged for teacher review
- **Files to create/modify**:
  - `lib/ai/exam-grader.ts`, `app/api/exams/grade/route.ts`, `lib/ai/ocr.ts`

---

### TASK-052: Exam results view â€” per student and class overview

- **Phase**: 3
- **Priority**: P1
- **Dependencies**: TASK-051
- **Estimated effort**: M
- **Description**: Build the exam results interface at `/laerer/prover/[id]/resultater`. Shows a class overview table (student name, total score %, score per part) and a per-student detail view. Low-confidence answers highlighted. Teacher can override AI scores. Results update via Supabase Realtime as grading completes.
- **Acceptance criteria**:
  - [ ] Class overview table: student name, Part 1 score, Part 2 score, total, confidence indicator
  - [ ] Clicking a student opens their detailed results
  - [ ] Per-student view: each question with student's OCR'd answer, AI score, confidence, and LLM feedback
  - [ ] Low-confidence questions (< 70%) shown with warning icon; teacher can review the scanned image
  - [ ] Teacher can override score for any question (numeric input); recalculates total
  - [ ] Override saves to `exam_answers` with `teacher_override = true`
  - [ ] Results update live as grading progresses (Supabase Realtime subscription)
  - [ ] Export to CSV button for grades
  - [ ] Class statistics: average score, median, score distribution histogram
- **Files to create/modify**:
  - `app/(teacher)/prover/[id]/resultater/page.tsx`, `components/exams/results-table.tsx`, `components/exams/student-result-detail.tsx`

---

### TASK-053: Student-generated practice exams

- **Phase**: 3
- **Priority**: P2
- **Dependencies**: TASK-047
- **Estimated effort**: M
- **Description**: Allow students to generate their own practice exams from the student interface. Student selects topics or competency goals, difficulty, and duration. System generates a practice exam using the same AI pipeline as teacher exams. Student can export as PDF or work through it interactively (self-report scoring).
- **Acceptance criteria**:
  - [ ] `/oving-prove` form: select competency goals, duration (30/45/60/90 min), difficulty
  - [ ] Uses same `POST /api/exams/generate` endpoint with `created_by = student`
  - [ ] Student-generated exams not visible to teacher in exam administration
  - [ ] Student can: "Last ned PDF" (print and do on paper) or "Svar digitalt" (interactive self-report)
  - [ ] Interactive mode: shows one question at a time; student self-reports; shows solution after each
  - [ ] Practice exam results saved to `exam_submissions` with `type = 'practice'`
  - [ ] Rate limit: 5 practice exams per day per student
- **Files to create/modify**:
  - `app/(student)/oving-prove/page.tsx`, `components/exams/practice-exam.tsx`

---

### TASK-054: Phase 3 integration test â€” exam workflow

- **Phase**: 3
- **Priority**: P1
- **Dependencies**: TASK-046 through TASK-053
- **Estimated effort**: S
- **Description**: Playwright E2E tests for the exam creation, PDF export, and results workflow.
- **Acceptance criteria**:
  - [ ] E2E: teacher creates exam â†’ preview renders correctly â†’ PDF download works
  - [ ] E2E: teacher uploads scanned PDF â†’ assigns pages â†’ grading starts â†’ results appear
  - [ ] E2E: student generates practice exam â†’ downloads PDF
  - [ ] All tests pass in CI
- **Files to create/modify**:
  - `e2e/exams.spec.ts`

---

## Phase 4 â€” Teacher Dashboard + Reports

**Goal**: Complete teacher oversight â€” class heatmap, per-student detail, AI reports, and content review workflow.

---

### TASK-055: Teacher dashboard â€” class overview with heatmap

- **Phase**: 4
- **Priority**: P1
- **Dependencies**: TASK-033, TASK-009
- **Estimated effort**: L
- **Description**: Build the teacher dashboard home at `/laerer`. Shows a class overview with a competency goal heatmap (students Ã— goals matrix, color-coded red/yellow/green). Also shows alert cards for students who are significantly behind the semester plan. Data computed from `student_profiles` and `activity_log`.
- **Acceptance criteria**:
  - [ ] Heatmap: rows = students, columns = competency goals (R1-01 to R1-12); cell color = mastery status
  - [ ] Heatmap cell tooltip on hover: shows student name, goal, and mastery percentage
  - [ ] Clicking a cell opens the student's profile detail for that goal
  - [ ] Alert section: students with `struggling_competency_goals` count > 3 highlighted
  - [ ] "Bak plan" indicator: students who are > 2 topics behind semester plan schedule
  - [ ] Class summary stats: average completion %, most-struggled goal, most-mastered goal
  - [ ] Real-time updates via Supabase Realtime or 5-minute polling
  - [ ] Responsive: heatmap scrolls horizontally on narrow viewports
- **Files to create/modify**:
  - `app/(teacher)/page.tsx`, `components/dashboard/class-heatmap.tsx`, `components/dashboard/alert-cards.tsx`, `lib/dashboard/aggregates.ts`

---

### TASK-056: Teacher dashboard â€” per-student detail view

- **Phase**: 4
- **Priority**: P1
- **Dependencies**: TASK-055, TASK-041
- **Estimated effort**: M
- **Description**: Build the per-student detail page at `/laerer/elev/[studentId]`. Shows the full student profile, activity history, exam results, chat usage summary, and the teacher's notes field. This is the teacher's view of the student â€” read-only profile with the addition of teacher notes.
- **Acceptance criteria**:
  - [ ] Displays `student_profiles` data: mastery grid, statistics, learning style, goals
  - [ ] Activity timeline: recent 30 days of `activity_log` entries (wiki views, exercises, chat usage)
  - [ ] Exam results list: all exams with score and date; clickable to detailed result
  - [ ] Chat usage summary: number of conversations, messages this week (not message content)
  - [ ] Teacher notes: `<textarea>` for `teacher_notes.content`; auto-saves on blur
  - [ ] Notes persisted in `teacher_notes` table (insert or update)
  - [ ] Breadcrumb: Klasse â†’ Elev
  - [ ] RLS verified: teacher can only see students in their classes
- **Files to create/modify**:
  - `app/(teacher)/elev/[studentId]/page.tsx`, `components/dashboard/student-detail.tsx`, `components/dashboard/teacher-notes.tsx`, `app/actions/teacher-notes.ts`

---

### TASK-057: AI-generated student assessment report

- **Phase**: 4
- **Priority**: P1
- **Dependencies**: TASK-056
- **Estimated effort**: M
- **Description**: Build the AI assessment report generator. Teacher clicks "Generer vurderingsrapport" on a student's detail page. The server sends aggregated (non-raw) student data to Claude Opus 4.6: mastered goals, struggling goals, exam scores, activity patterns. LLM generates a 200-300 word Norwegian assessment text suitable as input for grade-setting. Report saved to `teacher_notes` as a special note.
- **Acceptance criteria**:
  - [ ] "Generer vurderingsrapport" button on student detail page
  - [ ] Loading state: "Genererer rapport..." with spinner (10-30 second generation)
  - [ ] Report generated in fluent Norwegian, 200-300 words
  - [ ] Report content: strengths, areas for improvement, specific competency goal references, recommendations
  - [ ] Report explicitly states it is an AI-generated draft for teacher review
  - [ ] Report saved as a special `teacher_notes` row (`type = 'ai_report'`)
  - [ ] Teacher can edit the report text before saving final version
  - [ ] No raw personal data or message content sent to LLM â€” only aggregated metrics
  - [ ] ZDR enforced via Vercel AI Gateway
- **Files to create/modify**:
  - `app/api/teacher/assessment-report/route.ts`, `lib/ai/assessment-report.ts`, `components/dashboard/assessment-report.tsx`

---

### TASK-058: Teacher dashboard â€” exam administration panel

- **Phase**: 4
- **Priority**: P1
- **Dependencies**: TASK-052, TASK-055
- **Estimated effort**: S
- **Description**: Add exam administration to the teacher dashboard. Shows list of all exams for the teacher's classes: status (draft/ready/completed), creation date, and links to preview, results, and grading. Quick stats: number graded, average score.
- **Acceptance criteria**:
  - [ ] Exams list at `/laerer/prover` with status badges
  - [ ] Each exam row shows: title, subject, date created, status, average score (if graded)
  - [ ] Links: "Rediger" (draft), "Last ned PDF" (ready), "Se resultater" (completed)
  - [ ] "Ny prÃ¸ve" button links to TASK-046 form
  - [ ] Exams sorted by `created_at` descending
  - [ ] Empty state with call to action when no exams exist
- **Files to create/modify**:
  - `app/(teacher)/prover/page.tsx`

---

### TASK-059: Content review workflow in teacher/admin dashboard

- **Phase**: 4
- **Priority**: P1
- **Dependencies**: TASK-023, TASK-055
- **Estimated effort**: M
- **Description**: Integrate the content review workflow (from TASK-023) more tightly into the teacher/admin dashboard. Add a "Flagget innhold" alert on the dashboard home when there are items in `flagged` status. Build the flagged items queue as a prioritized review list. Track who reviewed what and when.
- **Acceptance criteria**:
  - [ ] Dashboard home shows badge count of flagged content items
  - [ ] `/admin/innhold/flagget` shows prioritized queue of flagged items (most recent first)
  - [ ] Each item shows: flag reason, content type, competency goal, generated content preview
  - [ ] Quick approve/reject actions without opening full side-by-side view
  - [ ] Reviewed-by audit trail visible (who approved, when)
  - [ ] Teacher (non-admin) sees `/laerer/innhold` with read-only view of published content; can flag items for admin review with a comment
- **Files to create/modify**:
  - `app/(admin)/innhold/flagget/page.tsx`, `components/admin/flagged-queue.tsx`, `app/(teacher)/innhold/page.tsx`

---

### TASK-060: Semester plan â€” teacher dashboard integration

- **Phase**: 4
- **Priority**: P1
- **Dependencies**: TASK-031, TASK-055
- **Estimated effort**: S
- **Description**: Add semester plan quick-view and shortcuts to the teacher dashboard. Show the upcoming week's planned topics in a dashboard widget. Link to full semester plan calendar. Show a warning if the class is significantly off-track vs. the semester plan.
- **Acceptance criteria**:
  - [ ] Dashboard widget: "Denne uken" shows 5 upcoming `semester_plan_entries` for the class
  - [ ] Each entry shows: date, topic title, entry type (topic/assessment/revision)
  - [ ] "Rediger semesterplan" link to TASK-031 calendar view
  - [ ] Off-track warning: if class average topic completion is > 2 topics behind plan schedule
- **Files to create/modify**:
  - `components/dashboard/semester-widget.tsx`, `app/(teacher)/page.tsx` (update)

---

### TASK-061: User administration panel (admin only)

- **Phase**: 4
- **Priority**: P1
- **Dependencies**: TASK-009
- **Estimated effort**: M
- **Description**: Build the admin user management panel at `/admin/brukere`. Lists all users with role, class membership, and last login. Admin can change user roles, deactivate accounts, and delete accounts (with GDPR data deletion cascade). Includes a bulk invite tool for importing students from a CSV file.
- **Acceptance criteria**:
  - [ ] `/admin/brukere` lists all `profiles` with: name, email, role, last login, class name
  - [ ] Role change: dropdown per user, saved via Server Action with audit log entry
  - [ ] Deactivate: sets `profiles.deactivated_at` (add migration); deactivated users cannot log in
  - [ ] Delete: hard delete from `auth.users` (cascades to `profiles` via FK); requires typing confirmation
  - [ ] CSV import: upload CSV with columns `name,email`; creates student accounts (sends invite emails)
  - [ ] Pagination: 50 users per page; search by name/email
- **Files to create/modify**:
  - `app/(admin)/brukere/page.tsx`, `app/actions/admin-users.ts`

---

### TASK-062: Phase 4 integration test â€” teacher dashboard

- **Phase**: 4
- **Priority**: P1
- **Dependencies**: TASK-055 through TASK-061
- **Estimated effort**: S
- **Description**: Playwright E2E tests for teacher dashboard flows.
- **Acceptance criteria**:
  - [ ] E2E: teacher views class heatmap â†’ clicks student â†’ sees detail page
  - [ ] E2E: teacher adds note for student â†’ note persists on reload
  - [ ] E2E: teacher generates assessment report â†’ report displayed and editable
  - [ ] E2E: admin changes user role â†’ role reflected in sidebar navigation
  - [ ] All tests pass in CI
- **Files to create/modify**:
  - `e2e/teacher-dashboard.spec.ts`

---

## Phase 5 â€” Flashcards + Video

**Goal**: Supplementary learning tools â€” spaced repetition flashcards and Manim-generated math explainer videos.

---

### TASK-063: Flashcard generation from published content

- **Phase**: 5
- **Priority**: P2
- **Dependencies**: TASK-021
- **Estimated effort**: M
- **Description**: Generate flashcards for published `content_elements` of type `flashcard`. Flashcards are already generated as part of the content pipeline (TASK-020), so this task focuses on the admin review and activation of flashcards, and building a batch generation script for any missing flashcards. Each flashcard has a front (term/formula) and back (definition/explanation).
- **Acceptance criteria**:
  - [ ] `content_elements` of type `flashcard` already exist from content pipeline
  - [ ] Script `scripts/generate-flashcards.ts` identifies published topics without flashcards and generates them
  - [ ] Each flashcard: front = term/formula (with KaTeX), back = definition + example sentence
  - [ ] Flashcards inserted with `status = 'draft'`; admin reviews via content review dashboard (TASK-023)
  - [ ] `flashcard_progress` rows created for each student-flashcard pair on first access (lazy init)
  - [ ] Admin can toggle a content element's `content_type` between `flashcard` and other types if miscategorized
- **Files to create/modify**:
  - `scripts/generate-flashcards.ts`, `lib/generation/flashcard-generator.ts`

---

### TASK-064: Flashcard study UI with SM-2 spaced repetition

- **Phase**: 5
- **Priority**: P2
- **Dependencies**: TASK-063, TASK-006
- **Estimated effort**: L
- **Description**: Build the flashcard study interface at `/flashcards`. Cards show front by default; tapping/clicking reveals the back. Student rates recall: "Husket" (correct), "Nesten" (partial), "Glemte" (incorrect). SM-2 algorithm updates `flashcard_progress`: ease factor, interval, next review date. Session shows "due today" cards first, then new cards.
- **Acceptance criteria**:
  - [ ] `/flashcards` shows today's due cards (sorted by `next_review <= today`)
  - [ ] Card front displayed with KaTeX rendering; back revealed on tap/click/spacebar
  - [ ] Three response buttons: "Husket" (quality 5), "Nesten" (quality 3), "Glemte" (quality 1)
  - [ ] SM-2 algorithm implemented in `lib/flashcards/sm2.ts`; Vitest unit tests for algorithm
  - [ ] `flashcard_progress` updated after each rating (Server Action)
  - [ ] Session ends when all due cards rated; "Kom tilbake i morgen" screen with next session date
  - [ ] Progress bar: N/total due cards completed in this session
  - [ ] Swipe gestures on mobile: swipe right = "Husket", swipe left = "Glemte"
  - [ ] `/flashcards/alle` shows all flashcards for the subject (for browsing)
- **Files to create/modify**:
  - `app/(student)/flashcards/page.tsx`, `components/flashcards/flashcard-card.tsx`, `components/flashcards/session.tsx`, `lib/flashcards/sm2.ts`, `app/actions/flashcards.ts`

---

### TASK-065: Mobile-optimized flashcard layout

- **Phase**: 5
- **Priority**: P2
- **Dependencies**: TASK-064
- **Estimated effort**: S
- **Description**: Ensure the flashcard interface is fully optimized for mobile use (375px+). This is the primary mobile use case per the PRD. Implement swipe gestures (Hammerjs or pointer events), full-screen card layout, large touch targets, and correct safe-area insets for notched phones.
- **Acceptance criteria**:
  - [ ] Cards fill the viewport on mobile (full-screen card style)
  - [ ] Swipe right gesture â†’ "Husket" (green flash)
  - [ ] Swipe left gesture â†’ "Glemte" (red flash)
  - [ ] Swipe up â†’ "Nesten" (yellow flash)
  - [ ] Touch targets for buttons â‰¥ 48Ã—48px (WCAG)
  - [ ] Bottom safe area padding applied (iPhone notch / home bar)
  - [ ] Flip animation on reveal (CSS 3D transform; respects `prefers-reduced-motion`)
  - [ ] No horizontal scroll; no accidental zoom on double-tap
- **Files to create/modify**:
  - `components/flashcards/flashcard-card.tsx` (update), `app/(student)/flashcards/page.tsx` (update)

---

### TASK-066: Manim video generation pipeline

- **Phase**: 5
- **Priority**: P2
- **Dependencies**: TASK-005
- **Estimated effort**: XL â€” split into TASK-066a and TASK-066b
- **Estimated effort**: L
- **Description**: Build the first half of the Manim pipeline: the script generation part. For each `content_elements` row of type `example`, generate a Manim Python script using Claude Sonnet 4.6. The script is stored in `videos.manim_script` with `status = 'generating'`. The actual rendering is in TASK-067.
- **Acceptance criteria**:
  - [ ] Script `scripts/generate-manim-scripts.ts` generates Manim scripts for all published examples without videos
  - [ ] LLM prompt includes the example content, solution steps, and Manim CE documentation examples
  - [ ] Generated script validated for Python syntax (basic AST parse)
  - [ ] Script stored in `videos.manim_script`; `videos.status = 'generating'`
  - [ ] Dry-run mode prints script without storing
  - [ ] Retry up to 3 times if script has syntax errors (LLM re-generation with error context)
- **Files to create/modify**:
  - `scripts/generate-manim-scripts.ts`, `lib/generation/manim-script-generator.ts`

---

### TASK-067: Manim video rendering and CDN upload

- **Phase**: 5
- **Priority**: P2
- **Dependencies**: TASK-066
- **Estimated effort**: L
- **Description**: Build the Manim rendering pipeline as a GitHub Actions workflow. The workflow runs on a schedule (nightly) or on-demand. It reads `videos` rows with `status = 'generating'` and `manim_script` populated, renders each script with Manim CE + ffmpeg in a Python container, and uploads the MP4 to Supabase Storage (`videos/` bucket). Updates `videos` row with `video_url`, `thumbnail_url`, `duration_seconds`, and `status = 'ready'`.
- **Acceptance criteria**:
  - [ ] GitHub Actions workflow `manim-render.yml` runs nightly at 02:00 UTC
  - [ ] Workflow: install Python 3.12, Manim CE, ffmpeg; process up to 20 scripts per run
  - [ ] Each script rendered with `manim -ql` (low quality for speed); full quality via flag
  - [ ] On success: MP4 uploaded to Supabase Storage `videos/[videoId].mp4`
  - [ ] Thumbnail generated with ffmpeg (frame at 1 second)
  - [ ] `videos` row updated: `video_url`, `thumbnail_url`, `duration_seconds`, `status = 'ready'`
  - [ ] On failure: `status = 'failed'`; error stored; LLM re-generation triggered (up to 3 attempts)
  - [ ] Rendering logs archived in GitHub Actions artifacts
- **Files to create/modify**:
  - `.github/workflows/manim-render.yml`, `scripts/render-manim.py`

---

### TASK-068: Video embedding in wiki

- **Phase**: 5
- **Priority**: P2
- **Dependencies**: TASK-067, TASK-024
- **Estimated effort**: S
- **Description**: Add video embedding to wiki pages. When a `content_elements` row has an associated `videos` row with `status = 'ready'`, a `<VideoPlayer>` component renders above or below the example content. Videos stored in Supabase Storage are streamed via signed URL. Log video watches in `activity_log`.
- **Acceptance criteria**:
  - [ ] `<VideoPlayer videoId="..." />` component renders a native HTML5 `<video>` player
  - [ ] Video streamed via Supabase Storage signed URL (24-hour expiry)
  - [ ] Thumbnail shown as poster image before play
  - [ ] Player controls: play/pause, seek, volume, fullscreen
  - [ ] On video complete: `activity_log` entry created (type `video_watched`, duration)
  - [ ] If no video exists for an example: no player rendered (graceful absence)
  - [ ] Videos lazy-loaded (Intersection Observer); not loaded until visible
- **Files to create/modify**:
  - `components/wiki/video-player.tsx`, `app/api/video/[id]/url/route.ts`

---

### TASK-069: Phase 5 integration test â€” flashcards and video

- **Phase**: 5
- **Priority**: P2
- **Dependencies**: TASK-063 through TASK-068
- **Estimated effort**: S
- **Description**: Playwright E2E tests for flashcard and video flows.
- **Acceptance criteria**:
  - [ ] E2E: student opens flashcards â†’ cards shown â†’ rates a card â†’ SM-2 interval updated
  - [ ] E2E: student swipes left on mobile viewport â†’ card marked as "Glemte"
  - [ ] E2E: wiki page loads with video â†’ clicking play starts video
  - [ ] All tests pass in CI
- **Files to create/modify**:
  - `e2e/flashcards.spec.ts`, `e2e/video.spec.ts`

---

## Phase 6 â€” Polish + Launch

**Goal**: Performance, accessibility (WCAG 2.1 AA), GDPR compliance, user testing, and production readiness for 50 students.

---

### TASK-070: Lighthouse performance audit and optimization

- **Phase**: 6
- **Priority**: P1
- **Dependencies**: All Phase 0-5 tasks
- **Estimated effort**: M
- **Description**: Run Lighthouse audit on all major pages and optimize to achieve > 90 in all categories (Performance, Accessibility, Best Practices, SEO). Focus on: image optimization, JS bundle size, LCP elements, and CLS. Document baseline scores and target scores.
- **Acceptance criteria**:
  - [ ] Lighthouse CI configured in GitHub Actions (`lighthouse-ci.yml`)
  - [ ] All major pages score > 90 in Performance, Accessibility, Best Practices
  - [ ] LCP < 2.5s on wiki pages (largest contentful paint)
  - [ ] No layout shift > 0.1 CLS on any page
  - [ ] JS bundle analyzed with `@next/bundle-analyzer`; no chunk > 200kB (gzipped)
  - [ ] Images served via `next/image` with correct sizes and formats
  - [ ] Pyodide, JSXGraph, R3F, and D3.js confirmed lazy-loaded (not in initial bundle)
  - [ ] Lighthouse scores documented in `docs/performance-baseline.md`
- **Files to create/modify**:
  - `.github/workflows/lighthouse-ci.yml`, `next.config.ts` (bundle analyzer), `docs/performance-baseline.md`

---

### TASK-071: WCAG 2.1 AA accessibility audit

- **Phase**: 6
- **Priority**: P1
- **Dependencies**: TASK-070
- **Estimated effort**: M
- **Description**: Conduct a thorough WCAG 2.1 AA audit using axe-core (automated) and manual keyboard/screen reader testing. Fix all Level A and AA violations. Special focus on: KaTeX math accessibility (ARIA), Mafs keyboard navigation, color contrast in all three themes, and form labels.
- **Acceptance criteria**:
  - [ ] `axe-core` integrated into Playwright tests; zero violations on all major pages
  - [ ] All form inputs have associated `<label>` elements or `aria-label`
  - [ ] KaTeX renders with `aria-label` containing the spoken math (e.g., "x squared plus 2")
  - [ ] Mafs visualizations have descriptive `aria-label` and keyboard-navigable points
  - [ ] All three themes (dark/light/UU) pass WCAG AA contrast ratio (4.5:1 for text)
  - [ ] Full keyboard navigation verified: Tab through all interactive elements, no focus traps
  - [ ] Screen reader test (VoiceOver or NVDA) passes on wiki page and chat interface
  - [ ] Skip-to-content link on all pages
  - [ ] Motion: all animations respect `prefers-reduced-motion`
- **Files to create/modify**:
  - `e2e/accessibility.spec.ts`, various component files (add ARIA attributes)

---

### TASK-072: GDPR compliance â€” DPIA and privacy infrastructure

- **Phase**: 6
- **Priority**: P0
- **Dependencies**: TASK-003, TASK-006
- **Estimated effort**: M
- **Description**: Implement the technical GDPR requirements. Write the DPIA (Data Protection Impact Assessment) document. Implement account deletion with data purge. Implement a privacy policy page. Ensure ZDR is verified on all LLM routes. Add a parental consent flow for students under 16.
- **Acceptance criteria**:
  - [ ] DPIA document completed and stored in `docs/dpia.md`
  - [ ] Account deletion: Server Action that deletes `auth.users` (cascades all user data); includes 30-day deferred purge option
  - [ ] Privacy policy page at `/personvern` (Norwegian, plain language)
  - [ ] Cookie banner on first visit (session cookies only â€” no tracking cookies in MVP)
  - [ ] Parental consent flag in `profiles.settings`: `requires_parental_consent: boolean`; admin manually sets for under-16 students
  - [ ] ZDR verified: Vercel AI Gateway "Data retention" set to OFF for all projects; documented in `docs/gdpr-checklist.md`
  - [ ] DPA agreements with Supabase, Vercel, and Google documented in `docs/dpa-log.md`
  - [ ] All image uploads auto-deleted from Storage after 90 days (Supabase Storage lifecycle rule)
- **Files to create/modify**:
  - `app/(public)/personvern/page.tsx`, `components/cookie-banner.tsx`, `app/actions/account.ts` (delete), `docs/dpia.md`, `docs/gdpr-checklist.md`

---

### TASK-073: Rate limiting hardening and security review

- **Phase**: 6
- **Priority**: P1
- **Dependencies**: TASK-015, TASK-072
- **Estimated effort**: M
- **Description**: Harden all security measures before launch. Review and tighten RLS policies. Verify all API routes require authentication. Ensure image uploads are scoped correctly. Add CSRF protection. Run a security checklist.
- **Acceptance criteria**:
  - [ ] All 20+ Supabase tables have RLS enabled; policies verified with SQL test scripts
  - [ ] All `app/api/` routes return 401 for unauthenticated requests (automated test)
  - [ ] Supabase Storage: `user-uploads/[userId]/` path enforced by RLS policy (users cannot access other users' files)
  - [ ] CORS configured: only the production domain allowed for API routes
  - [ ] Content Security Policy headers set in `next.config.ts`
  - [ ] Secrets: no hardcoded keys in any committed file (GitHub secret scanning enabled)
  - [ ] Rate limits verified working in staging environment
  - [ ] Security checklist documented in `docs/security-checklist.md`
- **Files to create/modify**:
  - `next.config.ts` (CSP headers), `docs/security-checklist.md`, RLS policy review

---

### TASK-074: Error monitoring and observability

- **Phase**: 6
- **Priority**: P1
- **Dependencies**: TASK-016
- **Estimated effort**: S
- **Description**: Complete the error monitoring and observability setup for production. Configure Sentry with Norwegian-locale source maps, alert rules, and performance monitoring. Set up Vercel Analytics for Core Web Vitals tracking. Create a simple admin health dashboard.
- **Acceptance criteria**:
  - [ ] Sentry configured for Next.js with source maps (server + client + edge)
  - [ ] Sentry alerts: notify on new error, spike in 500 errors, P95 response time > 3s
  - [ ] Vercel Analytics enabled; CWV (LCP, FID, CLS) tracked per page
  - [ ] Admin health page at `/admin/helse`: shows API response times, error rate last 24h, active users, DB connection status
  - [ ] No PII in Sentry events (user ID only, never email or name)
  - [ ] Sentry release tagging: each Vercel deploy creates a new Sentry release
- **Files to create/modify**:
  - `sentry.server.config.ts`, `sentry.client.config.ts`, `app/(admin)/helse/page.tsx`

---

### TASK-075: End-to-end user testing preparation

- **Phase**: 6
- **Priority**: P1
- **Dependencies**: TASK-071, TASK-072
- **Estimated effort**: M
- **Description**: Prepare for user testing with a group of 5-10 students and the teacher. Create test accounts, seed representative R1 content (at least 3 complete topics with all content types), prepare a testing guide with tasks, and set up feedback collection (simple form). Fix critical usability issues discovered in testing.
- **Acceptance criteria**:
  - [ ] 10 test student accounts created with sample activity data
  - [ ] At minimum 3 complete R1 topics published: theory + rules + examples + exercises + flashcards
  - [ ] Semester plan set up for the test class
  - [ ] Testing guide document: list of tasks for students and teacher to complete
  - [ ] Feedback form embedded in the app (simple NPS + open text)
  - [ ] All P0 and P1 bugs identified during testing fixed before launch
- **Files to create/modify**:
  - `scripts/seed-test-data.ts`, `docs/testing-guide.md`, `components/feedback/feedback-button.tsx`

---

### TASK-076: Production deployment checklist and launch

- **Phase**: 6
- **Priority**: P0
- **Dependencies**: TASK-070 through TASK-075
- **Estimated effort**: M
- **Description**: Execute the production launch checklist. Configure production Supabase (upgrade from free to Pro if needed), set all environment variables in Vercel production, configure custom domain, verify all integrations, run the full E2E test suite against production, and perform a soft launch with the teacher only before inviting students.
- **Acceptance criteria**:
  - [ ] Supabase Pro plan configured for production (EU Frankfurt)
  - [ ] Custom domain configured in Vercel with HTTPS (Let's Encrypt)
  - [ ] All environment variables verified in Vercel production environment
  - [ ] Full E2E test suite passes against production (not staging)
  - [ ] Teacher onboarded: class set up, semester plan created, 3+ topics published
  - [ ] Soft launch: teacher uses system for 1 week before student access
  - [ ] Student invites sent to class
  - [ ] Monitoring: Sentry and Vercel Analytics active and showing data
  - [ ] Incident response plan documented (who to call, what to do if the system goes down)
  - [ ] `LAUNCH.md` documents all configuration steps taken
- **Files to create/modify**:
  - `docs/LAUNCH.md`

---

### TASK-077: Student and teacher documentation

- **Phase**: 6
- **Priority**: P2
- **Dependencies**: TASK-075
- **Estimated effort**: M
- **Description**: Write in-app and external documentation for students and teachers. Student guide covers: how to use the wiki, how to submit exercises, how to use the chat tutor, and how to use flashcards. Teacher guide covers: setting up a class, creating the semester plan, creating and grading exams, and reviewing student progress.
- **Acceptance criteria**:
  - [ ] Student guide at `/hjelp/elev` (Norwegian, with screenshots)
  - [ ] Teacher guide at `/hjelp/laerer` (Norwegian, with screenshots)
  - [ ] In-app onboarding: first-time student sees a 3-step tooltip tour (wiki, chat, flashcards)
  - [ ] In-app onboarding: first-time teacher sees a 3-step tooltip tour (semester plan, class setup, exams)
  - [ ] FAQ section with the 10 most common questions
  - [ ] "Kontakt" page with the teacher's email for student questions
- **Files to create/modify**:
  - `app/(public)/hjelp/elev/page.tsx`, `app/(public)/hjelp/laerer/page.tsx`, `components/onboarding/tooltip-tour.tsx`

---

### TASK-078: Final regression test suite

- **Phase**: 6
- **Priority**: P0
- **Dependencies**: All tasks
- **Estimated effort**: M
- **Description**: Build and run the complete regression test suite covering all major user flows across all phases. This is the gating test for production launch. All tests must pass.
- **Acceptance criteria**:
  - [ ] Full Playwright E2E suite (from TASK-018, 036, 045, 054, 062, 069, and new tests in this task)
  - [ ] New tests: GDPR deletion flow, rate limiting enforcement, theme switching across all pages
  - [ ] All Vitest unit tests pass (SM-2, auto-check, RRF merge, plan generator)
  - [ ] TypeScript: `tsc --noEmit` passes with zero errors
  - [ ] ESLint: zero violations
  - [ ] Lighthouse CI: all pages > 90
  - [ ] axe-core: zero WCAG violations
  - [ ] Full suite runs in < 15 minutes in CI
- **Files to create/modify**:
  - `e2e/regression.spec.ts`, CI workflow updates

---

## Dependency Graph

```
Phase 0 (Foundation)
  001 â†’ 002, 003, 013, 016
  003 â†’ 004 â†’ 005 â†’ 006
  004 â†’ 007 â†’ 008 â†’ 009
  005 â†’ 012 â†’ 014
  009 â†’ 010, 014
  006 â†’ 017
  001 â†’ 011 â†’ 012
  009, 011 â†’ 014
  All 001-017 â†’ 018

Phase 1 (Content + Wiki)
  005 â†’ 019 â†’ 020 â†’ 021 â†’ 022 â†’ 023
  021 â†’ 035
  012, 021 â†’ 024 â†’ 025, 026, 027, 028, 029
  006, 009 â†’ 030 â†’ 031 â†’ 032
  025 â†’ 033 â†’ 034
  019-035 â†’ 036

Phase 2 (Chat)
  021 â†’ 037 â†’ 038 â†’ 039 â†’ 040, 044
  033 â†’ 041 â†’ 042
  038 â†’ 043
  037-044 â†’ 045

Phase 3 (Exams)
  005, 009 â†’ 046 â†’ 047 â†’ 048 â†’ 049 â†’ 050 â†’ 051 â†’ 052
  047 â†’ 053
  046-053 â†’ 054

Phase 4 (Dashboard)
  033, 009 â†’ 055 â†’ 056 â†’ 057
  052, 055 â†’ 058
  023, 055 â†’ 059
  031, 055 â†’ 060
  009 â†’ 061
  055-061 â†’ 062

Phase 5 (Flashcards + Video)
  021 â†’ 063 â†’ 064 â†’ 065
  005 â†’ 066 â†’ 067 â†’ 068
  063-068 â†’ 069

Phase 6 (Polish + Launch)
  All â†’ 070 â†’ 071
  003, 006 â†’ 072
  015, 072 â†’ 073
  016 â†’ 074
  071, 072 â†’ 075 â†’ 076, 077
  All â†’ 078
```

---

## Risk Register

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Mathematical errors in AI-generated content | High | High | TASK-022 quality flagging, TASK-023 admin review before publish |
| Puppeteer incompatibility with Vercel serverless | Medium | Medium | Use `@sparticuz/chromium`; test early in TASK-049 |
| Pyodide load time degrades wiki performance | Medium | Medium | Lazy-load on demand; measure in TASK-070 |
| Manim script generation fails for complex examples | Medium | Medium | 3-retry loop with error feedback in TASK-066 |
| OCR accuracy on poor handwriting | High | Medium | Confidence score + teacher override in TASK-051/052 |
| GDPR breach from LLM data retention | High | Low | ZDR enforced; verified in TASK-072; ZDR setting documented |
| SM-2 flashcard algorithm bugs | Low | Low | Vitest unit tests in TASK-064 |
| Cross-subject RAG returning irrelevant results | Medium | Medium | Confidence threshold; subject boosting in TASK-037 |
| Supabase RLS misconfiguration leaking student data | High | Low | RLS audit script in TASK-073; per-phase RLS tests |
| Scope too large for single developer | High | High | Strict phase gating; P2 tasks can be deferred post-launch |

---

## Notes for Implementors

1. **Start each task in a fresh context** (`/clear`) â€” do not load the full task list.
2. **P2 tasks** (TASK-028, 034, 035, 042, 043, 053, 065-069) can be deferred past initial launch if needed.
3. **XL tasks** have been split: TASK-066 (Manim scripts) and TASK-067 (Manim rendering) are separate.
4. **Environment variables** required before starting Phase 0: Supabase URL + anon key + service role key, Vercel AI Gateway key, Sentry DSN.
5. **Norwegian first**: all UI strings, error messages, and user-facing content must be in Norwegian from day one â€” not a translation afterthought.
6. **ZDR is non-negotiable**: verify Vercel AI Gateway ZDR setting is OFF for data retention before any student data touches an LLM call.
7. **Commit format**: `feat(TASK-XXX): short description` â€” one task per commit.
